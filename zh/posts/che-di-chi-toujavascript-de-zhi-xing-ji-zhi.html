<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>彻底吃透JavaScript的执行机制 | 小窝</title>
    <meta name="description" content="博客">
    <meta name="generator" content="VuePress 1.3.0">
    <link rel="icon" href="/favicon/favicon.ico">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/favicon/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/favicon/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="stylesheet" href="https://at.alicdn.com/t/font_1575342_85bw7q9vq8c.css" type="text/css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/baguettebox.js/1.11.0/baguetteBox.css" type="text/css">
  <link rel="stylesheet" href="https://unpkg.com/swiper/css/swiper.css" type="text/css">
  <link rel="stylesheet" href="https://cdn.bootcss.com/animate.css/3.7.2/animate.min.css" type="text/css">
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v1.7.0/mapbox-gl.css" type="text/css">
  <link rel="stylesheet" href="https://www.zhangxinxu.com/study/201903/css-idea/cssgram.min.css" type="text/css">
  <script src="https://cdn.jsdelivr.net/npm/react/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.firebase.com/js/client/2.0.4/firebase.js"></script>
  <script src="https://unpkg.com/swiper/js/swiper.js"></script>
  <script src="https://static.runoob.com/assets/qrcode/qrcode.min.js"></script>
  <script src="https://unpkg.com/vue-toasted"></script>
  <script src="https://cdn.bootcss.com/wow/1.1.2/wow.js"></script>
  <script src="https://cdn.bootcss.com/velocity/2.0.5/velocity.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/locale/zh-cn.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v1.7.0/mapbox-gl.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-language/v0.10.1/mapbox-gl-language.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/console-badge"></script>
  <link rel="alternate" type="application/rss+xml" href="https://luzhaoyang.com/rss.xml" title=" RSS Feed">
  <link rel="alternate" type="application/atom+xml" href="https://luzhaoyang.com/feed.atom" title=" Atom Feed">
  <link rel="alternate" type="application/json" href="https://luzhaoyang.com/feed.json" title=" JSON Feed">
    <meta property="null" content="null"><meta name="null" content="null"><meta property="og:title" content="彻底吃透JavaScript的执行机制"><meta property="og:type" content="website"><meta property="og:url" content="/zh/posts/che-di-chi-toujavascript-de-zhi-xing-ji-zhi.html"><meta name="twitter:title" content="彻底吃透JavaScript的执行机制"><meta name="twitter:url" content="/zh/posts/che-di-chi-toujavascript-de-zhi-xing-ji-zhi.html"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:label2" content="Filed under"><meta name="twitter:data2" content="前端开发"><meta property="article:tag" content="前端开发">
    <link rel="preload" href="/assets/css/0.styles.b1bdabc8.css" as="style"><link rel="preload" href="/assets/js/app.20b589a1.js" as="script"><link rel="preload" href="/assets/js/21.f825acf5.js" as="script"><link rel="preload" href="/assets/js/6.cfe3b70b.js" as="script"><link rel="preload" href="/assets/js/20.79d369cd.js" as="script"><link rel="preload" href="/assets/js/19.3996e2bb.js" as="script"><link rel="preload" href="/assets/js/27.f7590f54.js" as="script"><link rel="preload" href="/assets/js/1.35798176.js" as="script"><link rel="preload" href="/assets/js/5.c8a8d801.js" as="script"><link rel="preload" href="/assets/js/4.257a7894.js" as="script"><link rel="preload" href="/assets/js/24.07b0d058.js" as="script"><link rel="preload" href="/assets/js/87.571fb715.js" as="script"><link rel="preload" href="/assets/js/7.d6491bc5.js" as="script"><link rel="preload" href="/assets/js/14.1c7be7f5.js" as="script"><link rel="preload" href="/assets/js/2.d9691f81.js" as="script"><link rel="preload" href="/assets/js/12.2eb092a6.js" as="script"><link rel="preload" href="/assets/js/22.2f4cdc37.js" as="script"><link rel="preload" href="/assets/js/3.0a28d219.js" as="script"><link rel="prefetch" href="/assets/js/11.eee1fe0e.js"><link rel="prefetch" href="/assets/js/13.4e84f1f0.js"><link rel="prefetch" href="/assets/js/15.7803348f.js"><link rel="prefetch" href="/assets/js/16.55c9aaa6.js"><link rel="prefetch" href="/assets/js/17.92b0f279.js"><link rel="prefetch" href="/assets/js/18.c50c6843.js"><link rel="prefetch" href="/assets/js/23.d62d391f.js"><link rel="prefetch" href="/assets/js/25.d0431ac3.js"><link rel="prefetch" href="/assets/js/26.91feb214.js"><link rel="prefetch" href="/assets/js/28.553758a6.js"><link rel="prefetch" href="/assets/js/29.0834301c.js"><link rel="prefetch" href="/assets/js/30.dc9fff15.js"><link rel="prefetch" href="/assets/js/31.e49d3fed.js"><link rel="prefetch" href="/assets/js/32.e2d4e090.js"><link rel="prefetch" href="/assets/js/33.cfb93339.js"><link rel="prefetch" href="/assets/js/34.cf4d8cfb.js"><link rel="prefetch" href="/assets/js/35.7c720096.js"><link rel="prefetch" href="/assets/js/36.13fbc3ed.js"><link rel="prefetch" href="/assets/js/37.e04d21ba.js"><link rel="prefetch" href="/assets/js/38.3e963f5d.js"><link rel="prefetch" href="/assets/js/39.d1729e72.js"><link rel="prefetch" href="/assets/js/40.4567a5f3.js"><link rel="prefetch" href="/assets/js/41.5c728c9d.js"><link rel="prefetch" href="/assets/js/42.9c56c800.js"><link rel="prefetch" href="/assets/js/43.676abfe6.js"><link rel="prefetch" href="/assets/js/44.ea8545ad.js"><link rel="prefetch" href="/assets/js/45.29af040c.js"><link rel="prefetch" href="/assets/js/46.7e3cd429.js"><link rel="prefetch" href="/assets/js/47.6190f908.js"><link rel="prefetch" href="/assets/js/48.a09b6685.js"><link rel="prefetch" href="/assets/js/49.b265b07a.js"><link rel="prefetch" href="/assets/js/50.7d0ea405.js"><link rel="prefetch" href="/assets/js/51.b4b405ff.js"><link rel="prefetch" href="/assets/js/52.9270d916.js"><link rel="prefetch" href="/assets/js/53.2ff264db.js"><link rel="prefetch" href="/assets/js/54.d16124be.js"><link rel="prefetch" href="/assets/js/55.4d57d71f.js"><link rel="prefetch" href="/assets/js/56.6bcc52da.js"><link rel="prefetch" href="/assets/js/57.9eac68fb.js"><link rel="prefetch" href="/assets/js/58.1e2f730d.js"><link rel="prefetch" href="/assets/js/59.16c6c560.js"><link rel="prefetch" href="/assets/js/60.6db5b55f.js"><link rel="prefetch" href="/assets/js/61.ac9eeb66.js"><link rel="prefetch" href="/assets/js/62.de97a588.js"><link rel="prefetch" href="/assets/js/63.00e3a5fb.js"><link rel="prefetch" href="/assets/js/64.0d678644.js"><link rel="prefetch" href="/assets/js/65.9ffa77a8.js"><link rel="prefetch" href="/assets/js/66.0109a5e4.js"><link rel="prefetch" href="/assets/js/67.f24e0a56.js"><link rel="prefetch" href="/assets/js/68.2b53b24e.js"><link rel="prefetch" href="/assets/js/69.9c89d61d.js"><link rel="prefetch" href="/assets/js/70.0d8e118e.js"><link rel="prefetch" href="/assets/js/71.31e36c94.js"><link rel="prefetch" href="/assets/js/72.4df86c17.js"><link rel="prefetch" href="/assets/js/73.faac9eb5.js"><link rel="prefetch" href="/assets/js/74.90172a40.js"><link rel="prefetch" href="/assets/js/75.e6399289.js"><link rel="prefetch" href="/assets/js/76.baa161bc.js"><link rel="prefetch" href="/assets/js/77.da6df1f1.js"><link rel="prefetch" href="/assets/js/78.afff8519.js"><link rel="prefetch" href="/assets/js/79.ce34ded1.js"><link rel="prefetch" href="/assets/js/8.4c27a84c.js"><link rel="prefetch" href="/assets/js/80.e7200af2.js"><link rel="prefetch" href="/assets/js/81.cd02130b.js"><link rel="prefetch" href="/assets/js/82.dcbb7946.js"><link rel="prefetch" href="/assets/js/83.6e356ec5.js"><link rel="prefetch" href="/assets/js/84.8eb28dc4.js"><link rel="prefetch" href="/assets/js/85.77724785.js"><link rel="prefetch" href="/assets/js/86.d52ca160.js"><link rel="prefetch" href="/assets/js/88.553c13e4.js"><link rel="prefetch" href="/assets/js/89.5d91344b.js"><link rel="prefetch" href="/assets/js/90.424046f6.js"><link rel="prefetch" href="/assets/js/91.86411a4e.js"><link rel="prefetch" href="/assets/js/92.63c4960d.js"><link rel="prefetch" href="/assets/js/93.06e61d9a.js"><link rel="prefetch" href="/assets/js/94.2610b8eb.js"><link rel="prefetch" href="/assets/js/95.60a84312.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.148aed4f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b1bdabc8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div itemscope="itemscope" itemtype="https://schema.org/WebPage" class="layout-main"><meta itemprop="name" content=""> <meta itemprop="alternateName" content=""> <meta itemprop="url" content="http://luzhaoyang.com"> <nav aria-label="Navigation" itemscope="itemscope" itemtype="https://schema.org/SiteNavigationElement" class="container nav-mobile not-black" style="display:none;"><span itemprop="headline" class="nav-mobile__title not-black">导航</span> <ul class="nav-mobile__list not-black"><li class="nav-mobile__item not-black"><a href="/zh/categories/" itemprop="url" class="nav-mobile__link not-black"><span class="bullet no_bw bullet--primary bullet--undefined"></span> <span class="text not-black">文章分类</span></a></li><li class="nav-mobile__item not-black"><a href="/zh/gallery/" itemprop="url" class="nav-mobile__link not-black"><span class="bullet no_bw bullet--primary bullet--undefined"></span> <span class="text not-black">摄影相册</span></a></li><li class="nav-mobile__item not-black"><a href="/zh/comments/" itemprop="url" class="nav-mobile__link not-black"><span class="bullet no_bw bullet--primary bullet--undefined"></span> <span class="text not-black">我的留言</span></a></li><li class="nav-mobile__item not-black"><a href="/zh/travel/" itemprop="url" class="nav-mobile__link not-black"><span class="bullet no_bw bullet--primary bullet--undefined"></span> <span class="text not-black">旅行简记</span></a></li><li class="nav-mobile__item not-black"><a href="/zh/about/" itemprop="url" class="nav-mobile__link not-black"><span class="bullet no_bw bullet--primary bullet--undefined"></span> <span class="text not-black">关于我们</span></a></li><li class="nav-mobile__item not-black"><a href="/zh/contact/" itemprop="url" class="nav-mobile__link not-black"><span class="bullet no_bw bullet--primary bullet--undefined"></span> <span class="text not-black">联系我们</span></a></li><li class="nav-mobile__item not-black"><a href="/zh/categories/backend.html" itemprop="url" class="nav-mobile__link not-black"><span class="bullet no_bw bullet--primary bullet--undefined"></span> <span class="text not-black">后端开发</span></a></li><li class="nav-mobile__item not-black"><a href="/zh/categories/frontend.html" itemprop="url" class="nav-mobile__link not-black"><span class="bullet no_bw bullet--primary bullet--undefined"></span> <span class="text not-black">前端开发</span></a></li></ul></nav> <div class="container-fluid wrapper-body__nm"><header itemscope="itemscope" itemtype="https://schema.org/Organization" class="header"><!----> <div class="row header-top"><div class="column xs-33 sm-20"><div class="hamburguer header-top__hamburguer"><div class="hamburguer__wrapper"><span class="hamburguer__line"></span> <span class="hamburguer__line"></span> <span class="hamburguer__line"></span></div></div> <div class="languages header-top__languages"><div class="languages__box"><span class="languages__title meta-text">ZH</span> <span class="languages__icon"></span></div> <ul class="languages__list"><li class="languages__item"><a href="/" class="languages__link router-link-active">
        English
      </a></li><li class="languages__item"><a href="/zh/posts/che-di-chi-toujavascript-de-zhi-xing-ji-zhi.html" class="languages__link router-link-exact-active router-link-active">
        Chinese
      </a></li></ul></div></div> <div class="column xs-33 sm-60"><div class="header__logo"><a href="/zh/" itemprop="url" class="header-top-logo__link router-link-active"><img itemprop="logo" src="/ktquez-play-logo.png" srcset="/ktquez-play-logo.png 1x, /ktquez-play-logo@2x.png 2x" alt="小窝"></a></div> <meta itemprop="name" content=""> <meta itemprop="sameAs" content="https://i.youku.com/i/UNTcyNDQ2ODky?spm=a2hbt.13141534.1_1.1"><meta itemprop="sameAs" content="https://weibo.com/3032335637/profile?rightmod=1&amp;wvr=6&amp;mod=personinfo"><meta itemprop="sameAs" content="https://space.bilibili.com/25739142"></div> <div class="column xs-33 sm-20"><div class="search header-top__search"><!----> <span class="icon search__icon icon-search"></span></div> <div class="switch-bw header-top__toggle"><span class="switch-bw__text">
    开启夜间模式
  </span> <label for="switch-bw" class="switch-bw__label"><input type="checkbox" id="switch-bw" name="switch-bw" aria-labelledby="switch-bw-text" class="switch-bw__input"> <span class="switch-bw__ball"></span> <span id="switch-bw-text" hidden="hidden">switch to black or white</span></label></div></div></div></header> <main id="main" itemscope="itemscope" itemtype="https://schema.org/Blog" class="main-page"><div><a href="#main" class="vue-skip-to">跳到主要内容</a> <div><div class="page page__full row justify-right"><article itemscope="itemscope" itemprop="blogPost" itemtype="https://schema.org/BlogPosting" class="column xs-100 page__full__box box-default"><meta itemprop="mainEntityOfPage" content="/zh/posts/che-di-chi-toujavascript-de-zhi-xing-ji-zhi.html"> <header class="page-header page__full-header"><button type="button" class="ui-button reset-button back-button"><span class="icon back-button__icon icon--arrow icon-arrow"></span> <span class="back-button__text">返回</span></button> <div class="page-header__meta"><time datetime="Sun Dec 22 2019 16:00:00 GMT+0800 (GMT+08:00)" itemprop="datePublished" class="text">
            </time> <meta itemprop="dateModified" content="currentPost.updated_at"> <!----></div> <h1 itemprop="name headline" class="page-header__title">彻底吃透JavaScript的执行机制</h1> <div class="page-header-cat"><nav class="page-header-cat__nav"><ul class="page-header-cat__list"><li class="page-header-cat__item"><a href="/zh/categories/frontend.html" itemprop="keywords" class="page-header-cat__link meta-text">
                  前端开发
                </a></li></ul></nav></div> <div itemprop="author" itemscope="itemscope" itemtype="https://schema.org/Person" class="page-header__author"><strong>作者: </strong> <a href="/zh/authors/nuochong.html" rel="author" itemprop="url" class="link link--filler-s-primary"><span itemprop="name" class="not-black">诺冲</span></a></div></header> <!----> <!----> <section class="page-content page__full-content"><div class="row"><div class="column no-pad-l sm-50 post-share"><div class="observer" data-v-48c5c728><!----> <!----> <!----></div></div> <!----></div> <div class="row"><div class="column no-pad-l md-75 xl-67 post-content"><div class="post-content__box-player"><!----></div> <div class="post-content__excerpt"><!----></div> <div class="post-content__table-contents"><div class="table-contents"><h3 id="table-of-content" class="table-contents__title">目录</h3> <nav><ol class="table-contents__list"><li class="table-contents__item"><a href="#执行-运行" title="执行 &amp; 运行" class="table-contents__link"><span>执行 &amp; 运行</span></a></li><li class="table-contents__item"><a href="#关于-javascript" title="关于 JavaScript" class="table-contents__link"><span>关于 JavaScript</span></a></li><li class="table-contents__item"><a href="#概念梳理" title="概念梳理" class="table-contents__link"><span>概念梳理</span></a></li><!----><!----><!----><li class="table-contents__item"><a href="#宏任务-macrotask-、微任务-microtask" title="宏任务(MacroTask)、微任务(MicroTask)" class="table-contents__link"><span>宏任务(MacroTask)、微任务(MicroTask)</span></a></li><li class="table-contents__item"><a href="#浏览器环境下的event-loop" title="浏览器环境下的Event Loop" class="table-contents__link"><span>浏览器环境下的Event Loop</span></a></li><li class="table-contents__item"><a href="#settimeout、setinterval" title="setTimeout、setInterval" class="table-contents__link"><span>setTimeout、setInterval</span></a></li><!----><li class="table-contents__item"><a href="#打个比方" title="打个比方" class="table-contents__link"><span>打个比方</span></a></li><li class="table-contents__item"><a href="#setinterval" title="setInterval" class="table-contents__link"><span>setInterval</span></a></li><li class="table-contents__item"><a href="#promise" title="Promise" class="table-contents__link"><span>Promise</span></a></li><!----><!----><li class="table-contents__item"><a href="#node-环境下的-event-loop" title="Node 环境下的 Event Loop" class="table-contents__link"><span>Node 环境下的 Event Loop</span></a></li><li class="table-contents__item"><a href="#timers-阶段" title="timers 阶段" class="table-contents__link"><span>timers 阶段</span></a></li><!----><!----><li class="table-contents__item"><a href="#check-阶段" title="check 阶段" class="table-contents__link"><span>check 阶段</span></a></li><li class="table-contents__item"><a href="#close-callbacks-阶段" title="close callbacks 阶段" class="table-contents__link"><span>close callbacks 阶段</span></a></li><li class="table-contents__item"><a href="#setimmediate-vs-settimeout" title="setImmediate() vs setTimeout()" class="table-contents__link"><span>setImmediate() vs setTimeout()</span></a></li><li class="table-contents__item"><a href="#nexttick-queue" title="nextTick queue" class="table-contents__link"><span>nextTick queue</span></a></li><li class="table-contents__item"><a href="#node-与浏览器的-event-loop-差异" title="Node 与浏览器的 Event Loop 差异" class="table-contents__link"><span>Node 与浏览器的 Event Loop 差异</span></a></li><li class="table-contents__item"><a href="#最后" title="最后" class="table-contents__link"><span>最后</span></a></li><li class="table-contents__item"><a href="#参考文献" title="参考文献" class="table-contents__link"><span>参考文献</span></a></li></ol></nav></div></div> <div itemprop="articleBody"><div class="content__default"><h2 id="执行-运行"><a href="#执行-运行" class="header-anchor">#</a> 执行 &amp; 运行</h2> <p>首先我们需要声明下，<code>JavaScript</code>的执行和运行是两个不同概念的，执行，一般依赖于环境，比如<code>node</code>、浏览器、<code>Ringo</code>等，<code>JavaScript</code>在不同环境下的执行机制可能并不相同。而今天我们要讨论的<code>Event Loop</code>就是<code>JavaScript</code>的一种执行方式。所以下文我们还会梳理<code>node</code>的执行方式。而运行呢，是指 JavaScript 的解析引擎。这是统一的。</p> <h2 id="关于-javascript"><a href="#关于-javascript" class="header-anchor">#</a> 关于 JavaScript</h2> <p>此篇文章中，这个小标题下，我们只需要牢记一句话: JavaScript 是单线程语言 ，无论<code>HTML5</code>里面<code>Web-Worker</code>还是 node 里面的<code>cluster</code>都是“纸老虎”，而且<code>cluster</code>还是进程管理相关。这里读者注意区分：进程和线程。</p> <p>既然<code>JavaScript</code>是单线程语言，那么就会存在一个问题，所有的代码都得一句一句的来执行。就像我们在食堂排队打饭，必须一个一个排队点菜结账。那些没有排到的，就得等着~</p> <h2 id="概念梳理"><a href="#概念梳理" class="header-anchor">#</a> 概念梳理</h2> <p>在详解执行机制之前，先梳理一下<code>JavaScript</code>的一些基本概念，方便后面我们说到的时候大伙儿心里有个印象和大概的轮廓。</p> <h3 id="事件循环-event-loop"><a href="#事件循环-event-loop" class="header-anchor">#</a> 事件循环(Event Loop)</h3> <figure><img src="/images/%E5%BD%BB%E5%BA%95%E5%90%83%E9%80%8FJavaScript%E7%9A%84%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/640-1.webp" alt="An image"><figcaption>An image</figcaption></figure> <p><strong>什么是 Event Loop？</strong></p> <p>其实这个概念还是比较模糊的，因为他必须得结合着运行机制来解释。</p> <p><code>JavaScript</code>有一个主线程<code>main thread</code>，和调用栈<code>call-stack</code>也称之为执行栈。所有的任务都会放到调用栈中等待主线程来执行。</p> <p>暂且，我们先理解为上图的大圈圈就是 Event Loop 吧！并且，这个圈圈，一直在转圈圈~ 也就是说，<code>JavaScript</code>的<code>Event Loop</code>是伴随着整个源码文件生命周期的，只要当前 JavaScript 在运行中，内部的这个循环就会不断地循环下去，去寻找<code>queue</code>里面能执行的<code>task</code>。</p> <h3 id="任务队列-task-queue"><a href="#任务队列-task-queue" class="header-anchor">#</a> 任务队列(task queue)</h3> <p><code>task</code>，就是任务的意思，我们这里理解为每一个语句就是一个任务</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如上语句，其实就是就可以理解为两个<code>task</code>。</p> <p>而<code>queue</code>呢，就是<code>FIFO</code>的队列！</p> <p>所以<code>Task Queue</code>就是承载任务的队列。而<code>JavaScript</code>的<code>Event Loop</code>就是会不断地过来找这个<code>queue</code>，问有没有<code>task</code>可以运行运行。</p> <h3 id="同步任务-synctask-、异步任务-asynctask"><a href="#同步任务-synctask-、异步任务-asynctask" class="header-anchor">#</a> 同步任务(SyncTask)、异步任务(AsyncTask)</h3> <p>同步任务说白了就是主线程来执行的时候立即就能执行的代码，比如:</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'this is THE LAST TIME'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Nealyang'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>代码在执行到上述<code>console</code>的时候，就会立即在控制台上打印相应结果。</p> <p>而所谓的异步任务就是主线程执行到这个<code>task</code>的时候，“唉！你等会，我现在先不执行，等我 xxx 完了以后我再来等你执行” 注意上述我说的是等你来执行。</p> <p>说白了，异步任务就是你先去执行别的 task，等我这 xxx 完之后再往 Task Queue 里面塞一个 task 的同步任务来等待被执行</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如上述代码，<code>setTimeout</code>就是一个异步任务，主线程去执行的时候遇到<code>setTimeout</code>发现是一个异步任务，就先注册了一个异步的回调，然后接着执行下面的语句<code>console.log(1)</code>,等上面的异步任务等待的时间到了以后，在执行<code>console.log(2)</code>。具体的执行机制会在后面剖析。</p> <figure><img src="/images/%E5%BD%BB%E5%BA%95%E5%90%83%E9%80%8FJavaScript%E7%9A%84%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/640.webp" alt="An image"><figcaption>An image</figcaption></figure> <ul><li>主线程自上而下执行所有代码</li> <li>同步任务直接进入到主线程被执行，而异步任务则进入到<code>Event Table</code>并注册相对应的回调函数</li> <li>异步任务完成后，<code>Event Table</code>会将这个函数移入<code>Event Queue</code></li> <li>主线程任务执行完了以后，会从<code>Event Queue</code>中读取任务，进入到主线程去执行。</li> <li>循环如上</li></ul> <p>上述动作不断循环，就是我们所说的事件循环(<code>Event Loop</code>)。</p> <p>小试牛刀</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  url<span class="token operator">:</span> www<span class="token punctuation">.</span>Nealyang<span class="token punctuation">.</span>com<span class="token punctuation">,</span>
  data<span class="token operator">:</span> prams<span class="token punctuation">,</span>
  <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'请求成功!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'请求失败~'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'这是一个同步任务'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>ajax 请求首先进入到<code>Event Table</code>，分别注册了<code>onError和onSuccess</code>回调函数。</li> <li>主线程执行同步任务：<code>console.log('这是一个同步任务');</code></li> <li>主线程任务执行完毕，看<code>Event Queue</code>是否有待执行的 task,这里是不断地检查，只要主线程的<code>task queue</code>没有任务执行了，主线程就一直在这等着</li> <li>ajax 执行完毕，将回调函数<code>push</code>到<code>Event Queue</code>。（步骤 3、4 没有先后顺序而言）</li> <li>主线程“终于”等到了<code>Event Queue</code>里有<code>task</code>可以执行了，执行对应的回调任务。</li> <li>如此往复。</li></ul> <h2 id="宏任务-macrotask-、微任务-microtask"><a href="#宏任务-macrotask-、微任务-microtask" class="header-anchor">#</a> 宏任务(MacroTask)、微任务(MicroTask)</h2> <p><code>JavaScript</code>的任务不仅仅分为同步任务和异步任务，同时从另一个维度，也分为了宏任务(<code>MacroTask</code>)和微任务(<code>MicroTask</code>)。</p> <p>先说说<code>MacroTask</code>，所有的同步任务代码都是<code>MacroTask</code>（这么说其实不是很严谨，下面解释）,<code>setTimeout</code>、<code>setInterval</code>、<code>I/O</code>、<code>UI Rendering</code>等都是宏任务。</p> <p><code>MicroTask</code>，为什么说上述不严谨我却还是强调所有的同步任务都是<code>MacroTask</code>呢，因为我们仅仅需要记住几个 MicroTask 即可，排除法！别的都是 MacroTask。MicroTask 包括：Process.nextTick、Promise.then catch finally(注意我不是说 Promise)、MutationObserver。</p> <h2 id="浏览器环境下的event-loop"><a href="#浏览器环境下的event-loop" class="header-anchor">#</a> 浏览器环境下的<code>Event Loop</code></h2> <p>当我们梳理完哪些是<code>MicroTask</code>，除了那些别的都是<code>MacroTask</code>后，哪些是同步任务，哪些又是异步任务后，这里就应该彻底的梳理下 JavaScript 的执行机制了。</p> <p>如开篇说到的，执行和运行是不同的，执行要区分环境。所以这里我们将<code>Event Loop</code>的介绍分为浏览器和 Node 两个环境下。</p> <p>先放图镇楼！如果你已经理解了这张图的意思，那么恭喜你，你完全可以直接阅读 Node 环境下的<code>Event Loop</code>章节了！</p> <figure><img src="/images/%E5%BD%BB%E5%BA%95%E5%90%83%E9%80%8FJavaScript%E7%9A%84%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/640.gif" alt="An image"><figcaption>An image</figcaption></figure> <h2 id="settimeout、setinterval"><a href="#settimeout、setinterval" class="header-anchor">#</a> setTimeout、setInterval</h2> <h3 id="settimeout"><a href="#settimeout" class="header-anchor">#</a> setTimeout</h3> <p><code>setTimeout</code>就是等多长时间来执行这个回调函数。<code>setInterval</code>就是每隔多长时间来执行这个回调。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> startTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如上代码，顾名思义，就是等 1s 后再去执行<code>console</code>。放到浏览器下去执行，OK，如你所愿就是如此。</p> <p>但是这次我们在探讨 JavaScript 的执行机制，所以这里我们得探讨下如下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> startTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> startTime <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">开始执行回调的相隔时差：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">40000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><figure><img src="/images/%E5%BD%BB%E5%BA%95%E5%90%83%E9%80%8FJavaScript%E7%9A%84%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/640-2.webp" alt="An image"><figcaption>An image</figcaption></figure> <p>如上运行，setTimeout 的回调函数等到 4.7s 以后才执行!而这时候，我们把 setTimeout 的 1s 延迟给删了：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> startTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> startTime <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">开始执行回调的相隔时差：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">40000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><figure><img src="/images/%E5%BD%BB%E5%BA%95%E5%90%83%E9%80%8FJavaScript%E7%9A%84%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/640-3.webp" alt="An image"><figcaption>An image</figcaption></figure> <p>结果依然是等到 4.7s 后才执行 setTimeout 的回调。貌似 setTimeout 后面的延迟并没有产生任何效果！</p> <p>其实这么说，又应该回到上面的那张 JavaScript 执行的流程图了。</p> <figure><img src="/images/%E5%BD%BB%E5%BA%95%E5%90%83%E9%80%8FJavaScript%E7%9A%84%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/640-4.webp" alt="An image"><figcaption>An image</figcaption></figure> <p><code>setTimeout</code>这里就是简单的异步，我们通过上面的图来分析上述代码的一步一步执行情况</p> <ul><li>首先<code>JavaScript</code>自上而下执行代码</li> <li>遇到遇到赋值语句、以及第一个<code>console.log({startTime})</code>分别作为一个 task，压入到立即执行栈中被执行。</li> <li>遇到<code>setTImeout</code>是一个异步任务，则注册相应回调函数。（异步函数告诉你，js 你先别急，等 1s 后我再将回调函数：<code>console.log(xxx)</code>放到<code>Task Queue</code>中）</li> <li>OK，这时候 JavaScript 则接着往下走，遇到了 40000 个 for 循环的 task，没办法，1s 后都还没执行完。其实这个时候上述的回调已经在<code>Task Queue</code>中了。</li> <li>等所有的立即执行栈中的 task 都执行完了，在回头看<code>Task Queue</code>中的任务，发现异步的回调 task 已经在里面了，所以接着执行。</li></ul> <h2 id="打个比方"><a href="#打个比方" class="header-anchor">#</a> 打个比方</h2> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>其实上述的不仅仅是 timeout，而是任何异步，比如网络请求等。</p></div> <p>就好比，我六点钟下班了，可以安排下自己的活动了!</p> <p>然后收拾电脑(同步任务)、收拾书包(同步任务)、给女朋友打电话说出来吃饭吧(必然是异步任务)，然后女朋友说你等会，我先化个妆，等我画好了 call 你。</p> <p>那我不能干等着呀，就接着做别的事情，比如那我就在改个 bug 吧，你好了通知我。结果等她一个小时后说我化好妆了，我们出去吃饭吧。不行！我 bug 还没有解决掉呢？你等会。。。。其实这个时候你的一小时化妆还是 5 分钟化妆都已经毫无意义了。。。因为哥哥这会没空~~</p> <p>如果我 bug 在半个小时就解决完了，没别的任务需要执行了，那么就在这等着呀！必须等着！随时待命！。然后女朋友来电话了，我化完妆了，我们出去吃饭吧，那么刚好，我们在你的完成了请求或者 timeout 时间到了后我刚好闲着，那么我必须立即执行了。</p> <h2 id="setinterval"><a href="#setinterval" class="header-anchor">#</a> setInterval</h2> <p>说完了<code>setTimeout</code>，当然不能错过他的孪生兄弟：<code>setInterval</code>。对于执行顺序来说，<code>setInterval</code>会每隔指定的时间将注册的函数置入<code>Task Queue</code>，如果前面的任务耗时太久，那么同样需要等待。</p> <p>这里需要说的是，对于<code>setInterval(fn,ms)</code>来说，我们制定没<code>xx ms</code>执行一次 fn，其实是没<code>xx ms</code>，会有一个<code>fn</code>进入到<code>Task Queue</code>中。一旦 setInterval 的回调函数 fn 执行时间超过了 xx ms，那么就完全看不出来有时间间隔了。 仔细回味回味，是不是那么回事？</p> <h2 id="promise"><a href="#promise" class="header-anchor">#</a> Promise</h2> <p>关于<code>Promise</code>的用法，这里就不过过多介绍了，后面会在写《【THE LAST TIME】彻底吃透 JavaScript 异步》 一文的时候详细介绍。这里我们只说 JavaScript 的执行机制。</p> <p>如上所说，<code>promise.then</code>、<code>catch</code>和<code>finally</code>是属于<code>MicroTask</code>。这里主要是异步的区分。展开说明之前，我们结合上述说的，再来“扭曲”梳理一下。</p> <p>为了避免初学者这时候脑子有点混乱，我们暂时忘掉 JavaScript 异步任务！ 我们暂且称之为待会再执行的同步任务。</p> <p>有了如上约束后，我们可以说，JavaScript 从一开始就自上而下的执行每一个语句(Task),这时候只能遇到立马就要执行的任务和待会再执行的任务。对于那待会再执行的任务等到能执行了，也不会立即执行，你得等 js 执行完这一趟才行</p> <h3 id="再打个比方"><a href="#再打个比方" class="header-anchor">#</a> 再打个比方</h3> <p>就像做公交车一样，公交车不等人呀，公交车路线上有人就会停（农村公交！么得站牌），但是等公交车来，你跟司机说，我肚子疼要拉 x~这时候公交不会等你。你只能拉完以后等公交下一趟再来（大山里！一个路线就一趟车）。</p> <p>OK！你拉完了。。。等公交，公交也很快到了！但是，你不能立马上车，因为这时候前面有个孕妇！有个老人！还有熊孩子，你必须得让他们先上车，然后你才能上车！</p> <p>而这些 孕妇、老人、熊孩子所组成的就是传说中的<code>MicroTask Queue</code>,而且，就在你和你的同事、朋友就必须在他们后面上车。</p> <p>这里我们没有异步的概念，只有同样的一次循环回来，有了两种队伍，一种优先上车的队伍叫做<code>MicroTask Queue</code>，而你和你的同事这帮壮汉组成的队伍就是宏队伍(<code>MacroTask Queue</code>)。</p> <figure><img src="/images/%E5%BD%BB%E5%BA%95%E5%90%83%E9%80%8FJavaScript%E7%9A%84%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/640-5.webp" alt="An image"><figcaption>An image</figcaption></figure> <p>一句话理解：一次事件循环回来后，开始去执行<code>Task Queue</code>中的 task，但是这里的<code>task</code>有优先级。所以优先执行<code>MicroTask Queue</code>中的 task，执行完后在执行<code>MacroTask</code>Queue 中的 task</p> <h3 id="小试牛刀"><a href="#小试牛刀" class="header-anchor">#</a> 小试牛刀</h3> <p>理论都扯完了，也不知道你懂没懂。来，期中考试了！</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">提示</p> <p>没必要搞个 setTimeout 有加个 Promise，Promise 里面再整个 setTimeout 的例子。因为只要上面代码你懂了，无非就是公交再来一趟而已！</p></div> <figure><img src="/images/%E5%BD%BB%E5%BA%95%E5%90%83%E9%80%8FJavaScript%E7%9A%84%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/640-1.gif" alt="An image"><figcaption>An image</figcaption></figure> <p>如果说了这么多，还是没能理解上图，那么公众号内回复【1】，手摸手指导！</p> <h2 id="node-环境下的-event-loop"><a href="#node-环境下的-event-loop" class="header-anchor">#</a> Node 环境下的 Event Loop</h2> <p>Node 中的<code>Event Loop</code>是基于<code>libuv</code>实现的，而<code>libuv</code>是 Node 的新跨平台抽象层，<code>libuv</code>使用异步，事件驱动的编程方式，核心是提供<code>i/o</code>的事件循环和异步回调。<code>libuv</code>的 API 包含有时间，非阻塞的网络，异步文件操作，子进程等等。</p> <p>Event Loop 就是在<code>libuv</code>中实现的。所以关于 Node 的<code>Event Loop</code>学习，有两个官方途径可以学习:</p> <ul><li><p>libuv 文档</p></li> <li><p>官网的 What is the Event Loop?.</p></li></ul> <p>在学习 Node 环境下的 Event Loop 之前呢，我们首先要明确执行环境，Node 和浏览器的 Event Loop 是两个有明确区分的事物，不能混为一谈。nodejs 的 event 是基于 libuv，而浏览器的 event loop 则在 html5 的规范中明确定义。</p> <div class="language- extra-class"><pre class="language-text"><code>   ┌───────────────────────────┐
┌─&gt;│           timers          │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │     pending callbacks     │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │       idle, prepare       │
│  └─────────────┬─────────────┘      ┌───────────────┐
│  ┌─────────────┴─────────────┐      │   incoming:   │
│  │           poll            │&lt;─────┤  connections, │
│  └─────────────┬─────────────┘      │   data, etc.  │
│  ┌─────────────┴─────────────┐      └───────────────┘
│  │           check           │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
└──┤      close callbacks      │
   └───────────────────────────┘
</code></pre></div><p>Node 的 Event Loop 分为 6 个阶段：</p> <ul><li>timers：执行<code>setTimeout()</code>和<code>setInterval()</code>中到期的 callback。</li> <li>pending callback: 上一轮循环中有少数的<code>I/O</code>callback 会被延迟到这一轮的这一阶段执行</li> <li>idle, prepare：仅内部使用</li> <li>poll: 最为重要的阶段，执行<code>I/O</code>callback，在适当的条件下会阻塞在这个阶段</li> <li>check: 执行<code>setImmediate</code>的 callback</li> <li>close callbacks: 执行<code>close</code>事件的 callback，例如<code>socket.on('close'[,fn])</code>、<code>http.server.on('close, fn)</code></li></ul> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>上面六个阶段都不包括 process.nextTick()(下文会介绍)</p></div> <figure><img src="/images/%E5%BD%BB%E5%BA%95%E5%90%83%E9%80%8FJavaScript%E7%9A%84%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/640-6.webp" alt="An image"><figcaption>An image</figcaption></figure> <p>整体的执行机制如上图所示，下面我们具体展开每一个阶段的说明</p> <h2 id="timers-阶段"><a href="#timers-阶段" class="header-anchor">#</a> timers 阶段</h2> <p>timers 阶段会执行<code>setTimeout</code>和<code>setInterval</code>回调，并且是由 poll 阶段控制的。</p> <p>在 timers 阶段其实使用一个最小堆而不是队列来保存所有的元素，其实也可以理解，因为 timeout 的 callback 是按照超时时间的顺序来调用的，并不是先进先出的队列逻辑）。而为什么 timer 阶段在第一个执行阶梯上其实也不难理解。在 Node 中定时器指定的时间也是不准确的，而这样，就能尽可能的准确了，让其回调函数尽快执行。</p> <p>以下是官网给出的例子：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">someAsyncOperation</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Assume this takes 95ms to complete</span>
  fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'/path/to/file'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> timeoutScheduled <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> delay <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> timeoutScheduled<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>delay<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms have passed since I was scheduled</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// do someAsyncOperation which takes 95 ms to complete</span>
<span class="token function">someAsyncOperation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> startCallback <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// do something that will take 10ms...</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startCallback <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// do nothing</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>当进入事件循环时，它有一个空队列（<code>fs.readFile()</code>尚未完成），因此定时器将等待剩余毫秒数，当到达 95ms 时，<code>fs.readFile()</code>完成读取文件并且其完成需要 10 毫秒的回调被添加到轮询队列并执行。</p> <p>当回调结束时，队列中不再有回调，因此事件循环将看到已达到最快定时器的阈值，然后回到 timers 阶段以执行定时器的回调。在此示例中，您将看到正在调度的计时器与正在执行的回调之间的总延迟将为 105 毫秒。</p> <h3 id="pending-callbacks-阶段"><a href="#pending-callbacks-阶段" class="header-anchor">#</a> pending callbacks 阶段</h3> <p>pending callbacks 阶段其实是<code>I/O</code>的 callbacks 阶段。比如一些 TCP 的 error 回调等。</p> <p>举个栗子：如果<code>TCP socket ECONNREFUSED</code>在尝试<code>connect</code>时<code>receives</code>，则某些* nix 系统希望等待报告错误。这将在 pending callbacks 阶段执行。</p> <h3 id="poll-阶段"><a href="#poll-阶段" class="header-anchor">#</a> poll 阶段</h3> <p>poll 阶段主要有两个功能：</p> <ul><li>执行 I/O 回调</li> <li>处理 poll 队列（poll queue）中的事件</li></ul> <p>当时 Event Loop 进入到 poll 阶段并且 timers 阶段没有任何可执行的 task 的时候（也就是没有定时器回调），将会有以下两种情况</p> <ul><li>如果 poll queue 非空，则 Event Loop 就会执行他们，知道为空或者达到 system-dependent(系统相关限制)</li> <li>如果 poll queue 为空，则会发生以下一种情况
<ul><li>如果 setImmediate()有回调需要执行，则会立即进入到 check 阶段</li> <li>相反，如果没有 setImmediate()需要执行，则 poll 阶段将等待 callback 被添加到队列中再立即执行，这也是为什么我们说 poll 阶段可能会阻塞的原因。</li></ul></li></ul> <p>一旦 poll queue 为空，Event Loop 就回去检查 timer 阶段的任务。如果有的话，则会回到 timer 阶段执行回调。</p> <h2 id="check-阶段"><a href="#check-阶段" class="header-anchor">#</a> check 阶段</h2> <p>check 阶段在 poll 阶段之后，<code>setImmediate()</code>的回调会被加入 check 队列中，他是一个使用<code>libuv API</code>的特殊的计数器。</p> <p>通常在代码执行的时候，Event Loop 最终会到达 poll 阶段，然后等待传入的链接或者请求等，但是如果已经指定了 setImmediate()并且这时候 poll 阶段已经空闲的时候，则 poll 阶段将会被中止然后开始 check 阶段的执行。</p> <h2 id="close-callbacks-阶段"><a href="#close-callbacks-阶段" class="header-anchor">#</a> close callbacks 阶段</h2> <p>如果一个 socket 或者事件处理函数突然关闭/中断(比如：<code>socket.destroy()</code>),则这个阶段就会发生<code>close</code>的回调执行。否则他会通过<code>process.nextTick()</code>发出。</p> <h2 id="setimmediate-vs-settimeout"><a href="#setimmediate-vs-settimeout" class="header-anchor">#</a> setImmediate() vs setTimeout()</h2> <p><code>setImmediate()</code>和<code>setTimeout()</code>非常的相似，区别取决于谁调用了它。</p> <ul><li><code>setImmediate</code>在 poll 阶段后执行，即 check 阶段</li> <li><code>setTimeout</code>在 poll 空闲时且设定时间到达的时候执行，在 timer 阶段</li></ul> <p>计时器的执行顺序将根据调用它们的上下文而有所不同。如果两者都是从主模块中调用的，则时序将受到进程性能的限制。</p> <p>例如，如果我们运行以下不在 I / O 周期（即主模块）内的脚本，则两个计时器的执行顺序是不确定的，因为它受进程性能的约束：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// timeout_vs_immediate.js</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'immediate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>$ node timeout_vs_immediate.js
<span class="token function">timeout</span>
immediate
$ node timeout_vs_immediate.js
immediate
<span class="token function">timeout</span>
</code></pre></div><p>如果在一个<code>I/O</code>周期内移动这两个调用，则始终首先执行立即回调：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// timeout_vs_immediate.js</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>__filename<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'immediate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>$ node timeout_vs_immediate.js
immediate
<span class="token function">timeout</span>
$ node timeout_vs_immediate.js
immediate
<span class="token function">timeout</span>
</code></pre></div><p>所以与<code>setTimeout（）</code>相比，使用<code>setImmediate（）</code>的主要优点是，如果在<code>I / O</code>周期内安排了任何计时器，则<code>setImmediate（）</code>将始终在任何计时器之前执行，而与存在多少计时器无关。</p> <h2 id="nexttick-queue"><a href="#nexttick-queue" class="header-anchor">#</a> nextTick queue</h2> <p>可能你已经注意到<code>process.nextTick（）</code>并未显示在图中，即使它是异步 API 的一部分。所以他拥有一个自己的队列：<code>nextTickQueue</code>。</p> <p>这是因为<code>process.nextTick（）</code>从技术上讲不是 Event Loop 的一部分。相反，无论当前事件循环的当前阶段如何，都将在当前操作完成之后处理<code>nextTickQueue</code>。</p> <p>如果存在<code>nextTickQueue</code>，就会清空队列中的所有回调函数，并且优先于其他<code>microtask</code>执行。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timer1'</span><span class="token punctuation">)</span>
 Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1'</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nextTick'</span><span class="token punctuation">)</span>
 process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nextTick'</span><span class="token punctuation">)</span>
   process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nextTick'</span><span class="token punctuation">)</span>
     process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nextTick'</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// nextTick=&gt;nextTick=&gt;nextTick=&gt;nextTick=&gt;timer1=&gt;promise1</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> vs <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>从使用者角度而言，这两个名称非常的容易让人感觉到困惑。</p> <ul><li><code>process.nextTick（）</code>在同一阶段立即触发</li> <li><code>setImmediate（）</code>在事件循环的以下迭代或“tick”中触发</li></ul> <p>貌似这两个名称应该互换下！的确~官方也这么认为。但是他们说这是历史包袱，已经不会更改了。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>这里还是建议大家尽可能使用 setImmediate。因为更加的让程序可控容易推理。</p></div> <p>至于为什么还是需要<code>process.nextTick</code>，存在即合理。这里建议大家阅读官方文档：why-use-process-nexttick。</p> <h2 id="node-与浏览器的-event-loop-差异"><a href="#node-与浏览器的-event-loop-差异" class="header-anchor">#</a> Node 与浏览器的 Event Loop 差异</h2> <p>一句话总结其中：浏览器环境下，microtask 的任务队列是每个 macrotask 执行完之后执行。而在 Node.js 中，microtask 会在事件循环的各个阶段之间执行，也就是一个阶段执行完毕，就会去执行 microtask 队列的任务。</p> <figure><img src="/images/%E5%BD%BB%E5%BA%95%E5%90%83%E9%80%8FJavaScript%E7%9A%84%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/640-7.webp" alt="An image"><figcaption>An image</figcaption></figure> <h2 id="最后"><a href="#最后" class="header-anchor">#</a> 最后</h2> <p>来~期末考试了</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'6'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'7'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'9'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'10'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'11'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'12'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>评论区留下你的答案吧~~老铁！</p> <h2 id="参考文献"><a href="#参考文献" class="header-anchor">#</a> 参考文献</h2> <ul><li>Tasks, microtasks, queues and schedules</li> <li>libuv 文档</li> <li>The Node.js Event Loop, Timers, and process.nextTick()</li> <li>node 官网</li> <li>async/await 在 chrome 环境和 node 环境的 执行结果不一致，求解？</li> <li>更快的异步函数和 Promise</li> <li>一次弄懂 Event Loop（彻底解决此类面试问题）</li> <li>这一次，彻底弄懂 JavaScript 执行机制</li> <li>不要混淆 nodejs 和浏览器中的 event loop</li></ul> <p><a href="https://mp.weixin.qq.com/s/cOMlH-z5noHrg6Upg6zyNw" target="_blank" rel="noopener noreferrer">彻底吃透 JavaScript 的执行机制<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div></div></div> <div id="shangfang" class="column no-pad-r sm-25 xl-33 xsNone smNone post-sidebar"><!----> <div class="table-contents-fixed"><h3 id="table-of-content" class="table-contents__title">浮动目录</h3> <nav><ol class="table-contents__list"></ol></nav></div></div> <aside id="dibujuli" class="column xs-100"><hr class="divider"> <div><div class="observer" data-v-48c5c728><!----> <!----> <!----></div></div> <hr class="divider"> <section class="post-content__disqus"><!----></section></aside></div></section></article></div> <section class="row section-newsletter justify-center newsletter-post-wrap"><div class="column sm-100 md-67 xl-50"><div class="newsletter not-black"><span class="meta-text meta-text--primary not-black">关注我们</span> <h2 class="newsletter__title not-black">在收件箱接收新的内容推送</h2> <form method="post" action="https://luzhaoyang.us4.list-manage.com/subscribe/post?u=1de83ba90307cf0e38650d622&amp;amp;id=04aeba270a" class="newsletter__form not-black"><label for="email_news-1581073677018" class="newsletter__label not-black"><input type="email" name="EMAIL" id="email_news-1581073677018" required="required" placeholder="在这里输入您的电子邮件" autocomplete="off" aria-label="在这里输入您的电子邮件" value="" class="ui-input-field reset-input newsletter__input"></label> <button type="submit" class="ui-button reset-button newsletter__button txt-upper ui-button--primary">
        订阅
      </button></form></div></div></section> <aside class="container main"></aside></div> <!----> <div class="elevator"><a class="elevator__link"><span class="icon elevator__icon icon-greaterthan"></span> <!----></a></div> <!----></div></main> <footer id="footer" class="footer "><div class="footer-box1"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 1366 161" class="footer-box__shape"><path d="M-11.925-4809v-154.746c40.454,19.75,273.683,130.936,420.544,142.612,161.25,12.821,339.978-42.709,521.543-86.3,169.82-40.769,395.43,29.2,423.912,38.429v60Z" transform="translate(11.926 4970)"></path></svg></div> <div class="footer-box2"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 1366 246" class="footer-box__shape"><path d="M-1505.5-4725.5v-238.1c8.149-3.133,18.138-5.059,29.672-5.9h30.954c201.21,11.667,696.6,224.535,855.572,236.458,205.129,15.385,287.179-164.1,432.047-175.625a42.381,42.381,0,0,1,16.756,1.857V-4725.5Z" transform="translate(1506 4971)"></path></svg> <ul class="footer-social__list"><li class="footer-social__item"><a href="https://i.youku.com/i/UNTcyNDQ2ODky?spm=a2hbt.13141534.1_1.1" target="_blank" rel="noopener external" title="Follow us on Facebook"><span class="icon footer-social__icon icon-youku"></span></a></li><li class="footer-social__item"><a href="https://weibo.com/3032335637/profile?rightmod=1&amp;wvr=6&amp;mod=personinfo" target="_blank" rel="noopener external" title="Follow us on Facebook"><span class="icon footer-social__icon icon-sina"></span></a></li><li class="footer-social__item"><a href="https://space.bilibili.com/25739142" target="_blank" rel="noopener external" title="Follow us on Facebook"><span class="icon footer-social__icon icon-bilibili"></span></a></li></ul> <div class="footer-newsletter not-black"><div class="newsletter not-black"><span class="meta-text meta-text--primary not-black">关注我们</span> <h2 class="newsletter__title not-black">在收件箱接收新的内容推送</h2> <form method="post" action="https://luzhaoyang.us4.list-manage.com/subscribe/post?u=1de83ba90307cf0e38650d622&amp;amp;id=04aeba270a" class="newsletter__form not-black"><label for="email_news-1581073677189" class="newsletter__label not-black"><input type="email" name="EMAIL" id="email_news-1581073677189" required="required" placeholder="在这里输入您的电子邮件" autocomplete="off" aria-label="在这里输入您的电子邮件" value="" class="ui-input-field reset-input newsletter__input"></label> <button type="submit" class="ui-button reset-button newsletter__button txt-upper ui-button--primary">
        订阅
      </button></form></div></div></div> <section class="footer-box3"><div class="row"><div class="column sm-50 footer-card"><div class="observer" data-v-48c5c728><div class="spinner observer__spinner" data-v-48c5c728><div class="double-bounce1"></div> <div class="double-bounce2"></div></div> <!----> <!----></div></div> <div class="column sm-50 footer-nav"><div class="row justify-right"><div class="column xs-50 sm-40 md-33 footer-nav__box footer-nav__box--1 not-black"><h2 class="meta-text title not-black">我的小窝</h2> <nav class="footer-nav1"><ul><li class="footer-nav1__item"><a href="/zh/categories/" class="not-black">文章分类</a> <!----></li><li class="footer-nav1__item"><a href="/zh/gallery/" class="not-black">摄影相册</a> <!----></li><!----><li class="footer-nav1__item"><a href="/zh/travel/" class="not-black">旅行简记</a> <!----></li><li class="footer-nav1__item"><a href="/zh/about/" class="not-black">关于我们</a> <!----></li><li class="footer-nav1__item"><a href="/zh/contact/" class="not-black">联系我们</a> <!----></li></ul></nav></div> <div class="column xs-50 sm-40 md-33 footer-nav__box footer-nav__box--2"><h2 class="meta-text title not-black">社区</h2> <nav class="footer-nav2"><ul><li class="footer-nav2__item"><!----> <a href="https://jq.qq.com/?_wv=1027&amp;k=5sOoWzp" rel="noopener nofollow" target="_blank" class="not-black">Q群 931024509</a></li><li class="footer-nav2__item"><!----> <a href="https://nativescript-vue-examples.luzhaoyang.com/" rel="noopener nofollow" target="_blank" class="not-black">NSVue 示例</a></li></ul></nav></div></div></div> <div class="cpolumn sm-100 footer-copy"><p data-v-8d1f1b8e><span data-v-8d1f1b8e>累计访问</span> <span data-v-8d1f1b8e></span>
  次
</p> <p>2018 - 2020 © NUOCHONG - 源于 
  <a href="https://github.com/" rel="noopener" target="_blank">
    GITHUB
  </a></p></div></div> <span class="shapes shapes--circle" style="left: 3%; top: -20%"></span> <span class="shapes shapes--primary shapes--color3" style="left: 30%; top: -15%"></span> <span class="shapes shapes--primary" style="left: 13%; top: -80%; transform: rotate(45deg)"></span> <span class="shapes shapes--circle shapes--color4" style="left: 40%; top: 200px"></span> <span class="shapes shapes--primary" style="left: 15%; bottom: 10%; transform: rotate(75deg)"></span> <span class="shapes shapes--circle shapes--color3" style="right: 50%; top: 30%"></span> <span class="shapes shapes--primary" style="right: 20%; top: -100%"></span> <span class="shapes shapes--circle" style="right: 10%; top: -20%"></span> <span class="shapes shapes--color4" style="right: 35%; top: -20%; transform: rotate(45deg)"></span> <span class="shapes shapes--circle" style="left: 40%; top: -50%"></span> <span class="shapes shapes--color3" style="right: 30%; top: 20%"></span> <span class="shapes shapes--circle shapes--primary" style="right: 30%; bottom: 20%"></span></section></footer></div> <!----> <!----></div><div class="global-ui"><div><!----> <!----></div></div></div>
    <script src="/assets/js/app.20b589a1.js" defer></script><script src="/assets/js/21.f825acf5.js" defer></script><script src="/assets/js/6.cfe3b70b.js" defer></script><script src="/assets/js/20.79d369cd.js" defer></script><script src="/assets/js/19.3996e2bb.js" defer></script><script src="/assets/js/27.f7590f54.js" defer></script><script src="/assets/js/1.35798176.js" defer></script><script src="/assets/js/5.c8a8d801.js" defer></script><script src="/assets/js/4.257a7894.js" defer></script><script src="/assets/js/24.07b0d058.js" defer></script><script src="/assets/js/87.571fb715.js" defer></script><script src="/assets/js/7.d6491bc5.js" defer></script><script src="/assets/js/14.1c7be7f5.js" defer></script><script src="/assets/js/2.d9691f81.js" defer></script><script src="/assets/js/12.2eb092a6.js" defer></script><script src="/assets/js/22.2f4cdc37.js" defer></script><script src="/assets/js/3.0a28d219.js" defer></script>
  </body>
</html>
