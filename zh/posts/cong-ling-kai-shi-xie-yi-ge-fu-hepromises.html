<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>从零开始写一个符合Promises | 小窝</title>
    <meta name="description" content="博客">
    <meta name="generator" content="VuePress 1.3.0">
    <link rel="icon" href="/favicon/favicon.ico">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/favicon/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/favicon/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="stylesheet" href="https://at.alicdn.com/t/font_1575342_85bw7q9vq8c.css" type="text/css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/baguettebox.js/1.11.0/baguetteBox.css" type="text/css">
  <link rel="stylesheet" href="https://unpkg.com/swiper/css/swiper.css" type="text/css">
  <link rel="stylesheet" href="https://cdn.bootcss.com/animate.css/3.7.2/animate.min.css" type="text/css">
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v1.7.0/mapbox-gl.css" type="text/css">
  <link rel="stylesheet" href="https://www.zhangxinxu.com/study/201903/css-idea/cssgram.min.css" type="text/css">
  <script src="https://cdn.jsdelivr.net/npm/react/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.firebase.com/js/client/2.0.4/firebase.js"></script>
  <script src="https://unpkg.com/swiper/js/swiper.js"></script>
  <script src="https://static.runoob.com/assets/qrcode/qrcode.min.js"></script>
  <script src="https://unpkg.com/vue-toasted"></script>
  <script src="https://cdn.bootcss.com/wow/1.1.2/wow.js"></script>
  <script src="https://cdn.bootcss.com/velocity/2.0.5/velocity.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/locale/zh-cn.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v1.7.0/mapbox-gl.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-language/v0.10.1/mapbox-gl-language.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/console-badge"></script>
  <link rel="alternate" type="application/rss+xml" href="https://luzhaoyang.com/rss.xml" title=" RSS Feed">
  <link rel="alternate" type="application/atom+xml" href="https://luzhaoyang.com/feed.atom" title=" Atom Feed">
  <link rel="alternate" type="application/json" href="https://luzhaoyang.com/feed.json" title=" JSON Feed">
    <meta property="null" content="null"><meta name="null" content="null"><meta property="og:title" content="从零开始写一个符合Promises"><meta property="og:type" content="website"><meta property="og:url" content="/zh/posts/cong-ling-kai-shi-xie-yi-ge-fu-hepromises.html"><meta name="twitter:title" content="从零开始写一个符合Promises"><meta name="twitter:url" content="/zh/posts/cong-ling-kai-shi-xie-yi-ge-fu-hepromises.html"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:label2" content="Filed under"><meta name="twitter:data2" content="前端开发"><meta property="article:tag" content="前端开发">
    <link rel="preload" href="/assets/css/0.styles.b1bdabc8.css" as="style"><link rel="preload" href="/assets/js/app.f17750b6.js" as="script"><link rel="preload" href="/assets/js/21.f825acf5.js" as="script"><link rel="preload" href="/assets/js/6.cfe3b70b.js" as="script"><link rel="preload" href="/assets/js/20.79d369cd.js" as="script"><link rel="preload" href="/assets/js/19.3996e2bb.js" as="script"><link rel="preload" href="/assets/js/27.f7590f54.js" as="script"><link rel="preload" href="/assets/js/1.35798176.js" as="script"><link rel="preload" href="/assets/js/5.c8a8d801.js" as="script"><link rel="preload" href="/assets/js/4.257a7894.js" as="script"><link rel="preload" href="/assets/js/24.07b0d058.js" as="script"><link rel="preload" href="/assets/js/74.90172a40.js" as="script"><link rel="preload" href="/assets/js/7.d6491bc5.js" as="script"><link rel="preload" href="/assets/js/14.1c7be7f5.js" as="script"><link rel="preload" href="/assets/js/2.d9691f81.js" as="script"><link rel="preload" href="/assets/js/12.2eb092a6.js" as="script"><link rel="preload" href="/assets/js/22.2f4cdc37.js" as="script"><link rel="preload" href="/assets/js/3.0a28d219.js" as="script"><link rel="prefetch" href="/assets/js/11.eee1fe0e.js"><link rel="prefetch" href="/assets/js/13.4e84f1f0.js"><link rel="prefetch" href="/assets/js/15.7803348f.js"><link rel="prefetch" href="/assets/js/16.55c9aaa6.js"><link rel="prefetch" href="/assets/js/17.92b0f279.js"><link rel="prefetch" href="/assets/js/18.c50c6843.js"><link rel="prefetch" href="/assets/js/23.d62d391f.js"><link rel="prefetch" href="/assets/js/25.d0431ac3.js"><link rel="prefetch" href="/assets/js/26.91feb214.js"><link rel="prefetch" href="/assets/js/28.553758a6.js"><link rel="prefetch" href="/assets/js/29.0834301c.js"><link rel="prefetch" href="/assets/js/30.dc9fff15.js"><link rel="prefetch" href="/assets/js/31.e49d3fed.js"><link rel="prefetch" href="/assets/js/32.e2d4e090.js"><link rel="prefetch" href="/assets/js/33.cfb93339.js"><link rel="prefetch" href="/assets/js/34.cf4d8cfb.js"><link rel="prefetch" href="/assets/js/35.7c720096.js"><link rel="prefetch" href="/assets/js/36.13fbc3ed.js"><link rel="prefetch" href="/assets/js/37.9e30c69e.js"><link rel="prefetch" href="/assets/js/38.e4e64c46.js"><link rel="prefetch" href="/assets/js/39.858ea23b.js"><link rel="prefetch" href="/assets/js/40.721e99db.js"><link rel="prefetch" href="/assets/js/41.fd5737df.js"><link rel="prefetch" href="/assets/js/42.303535ba.js"><link rel="prefetch" href="/assets/js/43.76a40f44.js"><link rel="prefetch" href="/assets/js/44.ea8545ad.js"><link rel="prefetch" href="/assets/js/45.29af040c.js"><link rel="prefetch" href="/assets/js/46.7e3cd429.js"><link rel="prefetch" href="/assets/js/47.6190f908.js"><link rel="prefetch" href="/assets/js/48.a09b6685.js"><link rel="prefetch" href="/assets/js/49.b265b07a.js"><link rel="prefetch" href="/assets/js/50.7d0ea405.js"><link rel="prefetch" href="/assets/js/51.b4b405ff.js"><link rel="prefetch" href="/assets/js/52.9270d916.js"><link rel="prefetch" href="/assets/js/53.2ff264db.js"><link rel="prefetch" href="/assets/js/54.d16124be.js"><link rel="prefetch" href="/assets/js/55.e9362d45.js"><link rel="prefetch" href="/assets/js/56.8ecab7fb.js"><link rel="prefetch" href="/assets/js/57.9eac68fb.js"><link rel="prefetch" href="/assets/js/58.1e2f730d.js"><link rel="prefetch" href="/assets/js/59.16c6c560.js"><link rel="prefetch" href="/assets/js/60.4de2236b.js"><link rel="prefetch" href="/assets/js/61.b294d1a2.js"><link rel="prefetch" href="/assets/js/62.6d761db8.js"><link rel="prefetch" href="/assets/js/63.3d70a43c.js"><link rel="prefetch" href="/assets/js/64.0d678644.js"><link rel="prefetch" href="/assets/js/65.a5c4ab54.js"><link rel="prefetch" href="/assets/js/66.0109a5e4.js"><link rel="prefetch" href="/assets/js/67.f24e0a56.js"><link rel="prefetch" href="/assets/js/68.2b53b24e.js"><link rel="prefetch" href="/assets/js/69.460eba08.js"><link rel="prefetch" href="/assets/js/70.f912194d.js"><link rel="prefetch" href="/assets/js/71.31e36c94.js"><link rel="prefetch" href="/assets/js/72.4df86c17.js"><link rel="prefetch" href="/assets/js/73.408edc60.js"><link rel="prefetch" href="/assets/js/75.69a56673.js"><link rel="prefetch" href="/assets/js/76.baa161bc.js"><link rel="prefetch" href="/assets/js/77.da6df1f1.js"><link rel="prefetch" href="/assets/js/78.afff8519.js"><link rel="prefetch" href="/assets/js/79.ce34ded1.js"><link rel="prefetch" href="/assets/js/8.4c27a84c.js"><link rel="prefetch" href="/assets/js/80.e7200af2.js"><link rel="prefetch" href="/assets/js/81.cd02130b.js"><link rel="prefetch" href="/assets/js/82.dcbb7946.js"><link rel="prefetch" href="/assets/js/83.6e356ec5.js"><link rel="prefetch" href="/assets/js/84.470d7b8f.js"><link rel="prefetch" href="/assets/js/85.6461bf74.js"><link rel="prefetch" href="/assets/js/86.d52ca160.js"><link rel="prefetch" href="/assets/js/87.571fb715.js"><link rel="prefetch" href="/assets/js/88.553c13e4.js"><link rel="prefetch" href="/assets/js/89.28a81250.js"><link rel="prefetch" href="/assets/js/90.6391d660.js"><link rel="prefetch" href="/assets/js/91.86411a4e.js"><link rel="prefetch" href="/assets/js/92.63c4960d.js"><link rel="prefetch" href="/assets/js/93.06e61d9a.js"><link rel="prefetch" href="/assets/js/94.2610b8eb.js"><link rel="prefetch" href="/assets/js/95.60a84312.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.148aed4f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b1bdabc8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div itemscope="itemscope" itemtype="https://schema.org/WebPage" class="layout-main"><meta itemprop="name" content=""> <meta itemprop="alternateName" content=""> <meta itemprop="url" content="http://luzhaoyang.com"> <nav aria-label="Navigation" itemscope="itemscope" itemtype="https://schema.org/SiteNavigationElement" class="container nav-mobile not-black" style="display:none;"><span itemprop="headline" class="nav-mobile__title not-black">导航</span> <ul class="nav-mobile__list not-black"><li class="nav-mobile__item not-black"><a href="/zh/categories/" itemprop="url" class="nav-mobile__link not-black"><span class="bullet no_bw bullet--primary bullet--undefined"></span> <span class="text not-black">文章分类</span></a></li><li class="nav-mobile__item not-black"><a href="/zh/gallery/" itemprop="url" class="nav-mobile__link not-black"><span class="bullet no_bw bullet--primary bullet--undefined"></span> <span class="text not-black">摄影相册</span></a></li><li class="nav-mobile__item not-black"><a href="/zh/comments/" itemprop="url" class="nav-mobile__link not-black"><span class="bullet no_bw bullet--primary bullet--undefined"></span> <span class="text not-black">我的留言</span></a></li><li class="nav-mobile__item not-black"><a href="/zh/travel/" itemprop="url" class="nav-mobile__link not-black"><span class="bullet no_bw bullet--primary bullet--undefined"></span> <span class="text not-black">旅行简记</span></a></li><li class="nav-mobile__item not-black"><a href="/zh/about/" itemprop="url" class="nav-mobile__link not-black"><span class="bullet no_bw bullet--primary bullet--undefined"></span> <span class="text not-black">关于我们</span></a></li><li class="nav-mobile__item not-black"><a href="/zh/contact/" itemprop="url" class="nav-mobile__link not-black"><span class="bullet no_bw bullet--primary bullet--undefined"></span> <span class="text not-black">联系我们</span></a></li><li class="nav-mobile__item not-black"><a href="/zh/categories/backend.html" itemprop="url" class="nav-mobile__link not-black"><span class="bullet no_bw bullet--primary bullet--undefined"></span> <span class="text not-black">后端开发</span></a></li><li class="nav-mobile__item not-black"><a href="/zh/categories/frontend.html" itemprop="url" class="nav-mobile__link not-black"><span class="bullet no_bw bullet--primary bullet--undefined"></span> <span class="text not-black">前端开发</span></a></li></ul></nav> <div class="container-fluid wrapper-body__nm"><header itemscope="itemscope" itemtype="https://schema.org/Organization" class="header"><!----> <div class="row header-top"><div class="column xs-33 sm-20"><div class="hamburguer header-top__hamburguer"><div class="hamburguer__wrapper"><span class="hamburguer__line"></span> <span class="hamburguer__line"></span> <span class="hamburguer__line"></span></div></div> <div class="languages header-top__languages"><div class="languages__box"><span class="languages__title meta-text">ZH</span> <span class="languages__icon"></span></div> <ul class="languages__list"><li class="languages__item"><a href="/" class="languages__link router-link-active">
        English
      </a></li><li class="languages__item"><a href="/zh/posts/cong-ling-kai-shi-xie-yi-ge-fu-hepromises.html" class="languages__link router-link-exact-active router-link-active">
        Chinese
      </a></li></ul></div></div> <div class="column xs-33 sm-60"><div class="header__logo"><a href="/zh/" itemprop="url" class="header-top-logo__link router-link-active"><img itemprop="logo" src="/ktquez-play-logo.png" srcset="/ktquez-play-logo.png 1x, /ktquez-play-logo@2x.png 2x" alt="小窝"></a></div> <meta itemprop="name" content=""> <meta itemprop="sameAs" content="https://i.youku.com/i/UNTcyNDQ2ODky?spm=a2hbt.13141534.1_1.1"><meta itemprop="sameAs" content="https://weibo.com/3032335637/profile?rightmod=1&amp;wvr=6&amp;mod=personinfo"><meta itemprop="sameAs" content="https://space.bilibili.com/25739142"></div> <div class="column xs-33 sm-20"><div class="search header-top__search"><!----> <span class="icon search__icon icon-search"></span></div> <div class="switch-bw header-top__toggle"><span class="switch-bw__text">
    开启夜间模式
  </span> <label for="switch-bw" class="switch-bw__label"><input type="checkbox" id="switch-bw" name="switch-bw" aria-labelledby="switch-bw-text" class="switch-bw__input"> <span class="switch-bw__ball"></span> <span id="switch-bw-text" hidden="hidden">switch to black or white</span></label></div></div></div></header> <main id="main" itemscope="itemscope" itemtype="https://schema.org/Blog" class="main-page"><div><a href="#main" class="vue-skip-to">跳到主要内容</a> <div><div class="page page__full row justify-right"><article itemscope="itemscope" itemprop="blogPost" itemtype="https://schema.org/BlogPosting" class="column xs-100 page__full__box box-default"><meta itemprop="mainEntityOfPage" content="/zh/posts/cong-ling-kai-shi-xie-yi-ge-fu-hepromises.html"> <header class="page-header page__full-header"><button type="button" class="ui-button reset-button back-button"><span class="icon back-button__icon icon--arrow icon-arrow"></span> <span class="back-button__text">返回</span></button> <div class="page-header__meta"><time datetime="Sun Dec 15 2019 17:00:00 GMT+0800 (GMT+08:00)" itemprop="datePublished" class="text">
            </time> <meta itemprop="dateModified" content="currentPost.updated_at"> <!----></div> <h1 itemprop="name headline" class="page-header__title">从零开始写一个符合Promises</h1> <div class="page-header-cat"><nav class="page-header-cat__nav"><ul class="page-header-cat__list"><li class="page-header-cat__item"><a href="/zh/categories/frontend.html" itemprop="keywords" class="page-header-cat__link meta-text">
                  前端开发
                </a></li></ul></nav></div> <div itemprop="author" itemscope="itemscope" itemtype="https://schema.org/Person" class="page-header__author"><strong>作者: </strong> <a href="/zh/authors/nuochong.html" rel="author" itemprop="url" class="link link--filler-s-primary"><span itemprop="name" class="not-black">诺冲</span></a></div></header> <!----> <!----> <section class="page-content page__full-content"><div class="row"><div class="column no-pad-l sm-50 post-share"><div class="observer" data-v-48c5c728><!----> <!----> <!----></div></div> <!----></div> <div class="row"><div class="column no-pad-l md-75 xl-67 post-content"><div class="post-content__box-player"><!----></div> <div class="post-content__excerpt"><!----></div> <div class="post-content__table-contents"><div class="table-contents"><h3 id="table-of-content" class="table-contents__title">目录</h3> <nav><ol class="table-contents__list"><li class="table-contents__item"><a href="#前言" title="前言" class="table-contents__link"><span>前言</span></a></li><li class="table-contents__item"><a href="#开始" title="开始" class="table-contents__link"><span>开始</span></a></li><!----><!----><!----><li class="table-contents__item"><a href="#本节代码" title="本节代码" class="table-contents__link"><span>本节代码</span></a></li><li class="table-contents__item"><a href="#二-支持同步任务" title="二. 支持同步任务" class="table-contents__link"><span>二. 支持同步任务</span></a></li><!----><!----><li class="table-contents__item"><a href="#本节代码-2" title="本节代码" class="table-contents__link"><span>本节代码</span></a></li><li class="table-contents__item"><a href="#三-支持三种状态" title="三. 支持三种状态" class="table-contents__link"><span>三. 支持三种状态</span></a></li><!----><!----><li class="table-contents__item"><a href="#本节代码-3" title="本节代码" class="table-contents__link"><span>本节代码</span></a></li><li class="table-contents__item"><a href="#四-支持链式操作" title="四. 支持链式操作" class="table-contents__link"><span>四. 支持链式操作</span></a></li><li class="table-contents__item"><a href="#目标-4" title="目标" class="table-contents__link"><span>目标</span></a></li><li class="table-contents__item"><a href="#实现-4" title="实现" class="table-contents__link"><span>实现</span></a></li><li class="table-contents__item"><a href="#本节代码-4" title="本节代码" class="table-contents__link"><span>本节代码</span></a></li><li class="table-contents__item"><a href="#五-支持串行异步任务" title="五. 支持串行异步任务" class="table-contents__link"><span>五. 支持串行异步任务</span></a></li><li class="table-contents__item"><a href="#目标-5" title="目标" class="table-contents__link"><span>目标</span></a></li><li class="table-contents__item"><a href="#实现-5" title="实现" class="table-contents__link"><span>实现</span></a></li><!----><li class="table-contents__item"><a href="#六-达到-promises-a-规范" title="六. 达到 Promises/A+规范" class="table-contents__link"><span>六. 达到 Promises/A+规范</span></a></li><!----><!----><!----><li class="table-contents__item"><a href="#七-实现-promise-的-all，race，resolve，reject-方法" title="七. 实现 promise 的 all，race，resolve，reject 方法" class="table-contents__link"><span>七. 实现 promise 的 all，race，resolve，reject 方法</span></a></li><!----><!----><!----><li class="table-contents__item"><a href="#八-实现-promiseify-方法" title="八. 实现 promiseify 方法" class="table-contents__link"><span>八. 实现 promiseify 方法</span></a></li><li class="table-contents__item"><a href="#目标-8" title="目标" class="table-contents__link"><span>目标</span></a></li><li class="table-contents__item"><a href="#实现-8" title="实现" class="table-contents__link"><span>实现</span></a></li><li class="table-contents__item"><a href="#本节代码-8" title="本节代码" class="table-contents__link"><span>本节代码</span></a></li><li class="table-contents__item"><a href="#最后" title="最后" class="table-contents__link"><span>最后</span></a></li></ol></nav></div></div> <div itemprop="articleBody"><div class="content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>Promise 是异步编程的一种解决方案，比传统的解决方案回调函数和事件更合理更强大。它由社区最早提出和实现，ES6 将其写进了语言标准，统一了用法，原生提供了 Promise 对象。本篇不注重讲解 promise 的用法，关于用法，可以看阮一峰老师的 ECMAScript 6 系列里面的 Promise 部分：</p> <p>ECMAScript 6 : Promise 对象</p> <p>本篇主要讲解如何从零开始一步步的实现 promise 各项特性及功能，最终使其符合 Promises/A+规范，因为讲解较细，所以文章略长。另外，每一步的项目源码都在 github 上，可以对照参考，每一步都有对应的项目代码及测试代码，喜欢的话，欢迎给个 star~</p> <h2 id="开始"><a href="#开始" class="header-anchor">#</a> 开始</h2> <p>本文 promise 里用到的异步操作的示例都是使用的 node 里面的 fs.readFile 方法，在浏览器端可以使用 setTimeout 方法进行模拟异步操作。</p> <h3 id="一-基础版本"><a href="#一-基础版本" class="header-anchor">#</a> 一. 基础版本</h3> <h3 id="目标"><a href="#目标" class="header-anchor">#</a> 目标</h3> <p>可以创建 promise 对象实例。</p> <p>promise 实例传入的异步方法执行成功就执行注册的成功回调函数，失败就执行注册的失败回调函数。</p> <h3 id="实现"><a href="#实现" class="header-anchor">#</a> 实现</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">MyPromise</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token comment">// 缓存当前promise实例</span>
  self<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">//成功时的值</span>
  self<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">//失败时的原因</span>
  self<span class="token punctuation">.</span>onFulfilled <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">//成功的回调函数</span>
  self<span class="token punctuation">.</span>onRejected <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">//失败的回调函数</span>
  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    self<span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//resolve时执行成功回调</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span>error <span class="token operator">=</span> error<span class="token punctuation">;</span>
    self<span class="token punctuation">.</span><span class="token function">onRejected</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//reject时执行失败回调</span>
  <span class="token punctuation">}</span>
  <span class="token function">fn</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//在这里给promise实例注册成功和失败回调</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilled <span class="token operator">=</span> onFulfilled<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>onRejected <span class="token operator">=</span> onRejected<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> MyPromise<span class="token punctuation">;</span>
</code></pre></div><p>代码很短，逻辑也非常清晰，在 then 中注册了这个 promise 实例的成功回调和失败回调，当 promise reslove 时，就把异步执行结果赋值给 promise 实例的 value，并把这个值传入成功回调中执行，失败就把异步执行失败原因赋值给 promise 实例的 error，并把这个值传入失败回调并执行。</p> <h2 id="本节代码"><a href="#本节代码" class="header-anchor">#</a> 本节代码</h2> <p>基础版本代码</p> <h2 id="二-支持同步任务"><a href="#二-支持同步任务" class="header-anchor">#</a> 二. 支持同步任务</h2> <p>我们知道，我们在使用 es6 的 promise 时，可以传入一个异步任务，也可以传入一个同步任务，但是我们的上面基础版代码并不支持同步任务，如果我们这样写就会报错：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'同步任务执行'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>为什么呢？因为是同步任务，所以当我们的 promise 实例 reslove 时，它的 then 方法还没执行到，所以回调函数还没注册上，这时 reslove 中调用成功回调肯定会报错的。</p> <h3 id="目标-2"><a href="#目标-2" class="header-anchor">#</a> 目标</h3> <p>使 promise 支持同步方法</p> <h3 id="实现-2"><a href="#实现-2" class="header-anchor">#</a> 实现</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//利用setTimeout特性将具体执行放到then之后</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    self<span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span>error <span class="token operator">=</span> error<span class="token punctuation">;</span>
    self<span class="token punctuation">.</span><span class="token function">onRejected</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>实现很简单，就是在 reslove 和 reject 里面用 setTimeout 进行包裹，使其到 then 方法执行之后再去执行，这样我们就让 promise 支持传入同步方法，另外，关于这一点，Promise/A+规范里也明确要求了这一点。
<code>2.2.4 onFulfilled or onRejected must not be called until the execution context stack contains only platform code.</code></p> <h2 id="本节代码-2"><a href="#本节代码-2" class="header-anchor">#</a> 本节代码</h2> <p>支持同步任务代码</p> <h2 id="三-支持三种状态"><a href="#三-支持三种状态" class="header-anchor">#</a> 三. 支持三种状态</h2> <p>我们知道在使用 promise 时，promise 有三种状态:pending（进行中）、fulfilled（已成功）和 rejected（已失败）。只有异步操作的结果，可以决定当前是哪一种状态，任何其他操作都无法改变这个状态。另外，promise 一旦状态改变，就不会再变，任何时候都可以得到这个结果 promise 对象的状态改变，只有两种可能：从 pending 变为 fulfilled 和从 pending 变为 rejected。只要这两种情况发生，状态就凝固了，不会再变了，会一直保持这个结果，如果改变已经发生了，你再对 promise 对象添加回调函数，也会立即得到这个结果。</p> <h3 id="目标-3"><a href="#目标-3" class="header-anchor">#</a> 目标</h3> <ol><li>实现 promise 的三种状态。</li> <li>实现 promise 对象的状态改变，改变只有两种可能：从 pending 变为 fulfilled 和从 pending 变为 rejected。</li> <li>实现一旦 promise 状态改变，再对 promise 对象添加回调函数，也会立即得到这个结果。</li></ol> <h3 id="实现-3"><a href="#实现-3" class="header-anchor">#</a> 实现</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//定义三种状态</span>
<span class="token keyword">const</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">MyPromise</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">PENDING</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>onFulfilled <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>onRejected <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//如果状态是pending才去修改状态为fulfilled并执行成功逻辑</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">FULFILLED</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
        self<span class="token punctuation">.</span><span class="token function">onFulfilled</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//如果状态是pending才去修改状态为rejected并执行失败逻辑</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">REJECTED</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>error <span class="token operator">=</span> error<span class="token punctuation">;</span>
        self<span class="token punctuation">.</span><span class="token function">onRejected</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">fn</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilled <span class="token operator">=</span> onFulfilled<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onRejected <span class="token operator">=</span> onRejected<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//如果状态是fulfilled，直接执行成功回调，并将成功值传入</span>
    <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//如果状态是rejected，直接执行失败回调，并将失败原因传入</span>
    <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> MyPromise<span class="token punctuation">;</span>
</code></pre></div><p>首先，我们建立了三种状态&quot;pending&quot;,“fulfilled”,“rejected”,然后我们在 reslove 和 reject 中做判断，只有状态是 pending 时，才去改变 promise 的状态，并执行相应操作，另外，我们在 then 中判断，如果这个 promise 已经变为&quot;fulfilled&quot;或&quot;rejected&quot;就立刻执行它的回调，并把结果传入。</p> <h2 id="本节代码-3"><a href="#本节代码-3" class="header-anchor">#</a> 本节代码</h2> <p>支持三种状态代码</p> <h2 id="四-支持链式操作"><a href="#四-支持链式操作" class="header-anchor">#</a> 四. 支持链式操作</h2> <p>我们平时写 promise 一般都是对应的一组流程化的操作，如这样：
promise.then(f1).then(f2).then(f3)
但是我们之前的版本最多只能注册一个回调，这一节我们就来实现链式操作。</p> <h2 id="目标-4"><a href="#目标-4" class="header-anchor">#</a> 目标</h2> <p>使 promise 支持链式操作</p> <h2 id="实现-4"><a href="#实现-4" class="header-anchor">#</a> 实现</h2> <p>想支持链式操作，其实很简单，首先存储回调时要改为使用数组</p> <div class="language-js extra-class"><pre class="language-js"><code>self<span class="token punctuation">.</span>onFulfilledCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
self<span class="token punctuation">.</span>onRejectedCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>当然执行回调时，也要改成遍历回调数组执行回调函数</p> <div class="language-js extra-class"><pre class="language-js"><code>self<span class="token punctuation">.</span>onFulfilledCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">callback</span> <span class="token operator">=&gt;</span> <span class="token function">callback</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>最后，then 方法也要改一下,只需要在最后一行加一个 return this 即可，这其实和 jQuery 链式操作的原理一致，每次调用完方法都返回自身实例，后面的方法也是实例的方法，所以可以继续执行。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="本节代码-4"><a href="#本节代码-4" class="header-anchor">#</a> 本节代码</h2> <p>支持链式操作代码</p> <h2 id="五-支持串行异步任务"><a href="#五-支持串行异步任务" class="header-anchor">#</a> 五. 支持串行异步任务</h2> <p>我们上一节实现了链式调用，但是目前 then 方法里只能传入同步任务，但是我们平常用 promise，then 方法里一般是异步任务，因为我们用 promise 主要用来解决一组流程化的异步操作，如下面这样的调取接口获取用户 id 后，再根据用户 id 调取接口获取用户余额，获取用户 id 和获取用户余额都需要调用接口，所以都是异步任务，如何使 promise 支持串行异步操作呢?</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>getUserBalanceById<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">balance</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// do sth</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="目标-5"><a href="#目标-5" class="header-anchor">#</a> 目标</h2> <p>使 promise 支持串行异步操作</p> <h2 id="实现-5"><a href="#实现-5" class="header-anchor">#</a> 实现</h2> <p>这里为方便讲解我们引入一个常见场景：用 promise 顺序读取文件内容，场景代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'../file/1.txt'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    err <span class="token operator">?</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token function-variable function">f1</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'../file/2.txt'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      err <span class="token operator">?</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token function-variable function">f2</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'../file/3.txt'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      err <span class="token operator">?</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token function-variable function">f3</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token function-variable function">errorLog</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>f1<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>f2<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>f3<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>errorLog<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//会依次输出</span>
<span class="token comment">//this is 1.txt</span>
<span class="token comment">//this is 2.txt</span>
<span class="token comment">//this is 3.txt</span>
</code></pre></div><p>上面场景，我们读取完 1.txt 后并打印 1.txt 内容，再去读取 2.txt 并打印 2.txt 内容，再去读取 3.txt 并打印 3.txt 内容，而读取文件都是异步操作，所以都是返回一个 promise，我们上一节实现的 promise 可以实现执行完异步操作后执行后续回调，但是本节的回调读取文件内容操作并不是同步的，而是异步的，所以当读取完 1.txt 后，执行它回调 onFulfilledCallbacks 里面的 f1，f2，f3 时，异步操作还没有完成，所以我们本想得到这样的输出：</p> <div class="language- extra-class"><pre class="language-text"><code>this is 1.txt
this is 2.txt
this is 3.txt
</code></pre></div><p>但是实际上却会输出</p> <div class="language- extra-class"><pre class="language-text"><code>this is 1.txt
this is 1.txt
this is 1.txt
</code></pre></div><p>所以要想实现异步操作串行，我们不能将回调函数都注册在初始 promise 的 onFulfilledCallbacks 里面，而要将每个回调函数注册在对应的异步操作 promise 的 onFulfilledCallbacks 里面，用读取文件的场景来举例，f1 要在 p 的 onFulfilledCallbacks 里面，而 f2 应该在 f1 里面 return 的那个 Promise 的 onFulfilledCallbacks 里面，因为只有这样才能实现读取完 2.txt 后才去打印 2.txt 的结果。</p> <p>但是，我们平常写 promise 一般都是这样写的: promise.then(f1).then(f2).then(f3)，一开始所有流程我们就指定好了，而不是在 f1 里面才去注册 f1 的回调，f2 里面才去注册 f2 的回调。</p> <p>如何既能保持这种链式写法的同时又能使异步操作衔接执行呢？我们其实让 then 方法最后不再返回自身实例，而是返回一个新的 promise 即可，我们可以叫它 bridgePromise，它最大的作用就是衔接后续操作，我们看下具体实现代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> bridgePromise<span class="token punctuation">;</span>
  <span class="token comment">//防止使用者不传成功或失败回调函数，所以成功失败回调都给了默认回调函数</span>
  onFulfilled <span class="token operator">=</span> <span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onFulfilled</span> <span class="token operator">:</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> value<span class="token punctuation">;</span>
  onRejected <span class="token operator">=</span>
    <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span>
      <span class="token operator">?</span> <span class="token function-variable function">onRejected</span>
      <span class="token operator">:</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>bridgePromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>bridgePromise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>bridgePromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>bridgePromise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>bridgePromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      self<span class="token punctuation">.</span>onFulfilledCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>bridgePromise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      self<span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>bridgePromise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//catch方法其实是个语法糖，就是只传onRejected不传onFulfilled的then方法</span>
<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">catch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//用来解析回调函数的返回值x，x可能是普通值也可能是个promise对象</span>
<span class="token keyword">function</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">bridgePromise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//如果x是一个promise</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//如果这个promise是pending状态，就在它的then方法里继续执行resolvePromise解析它的结果，直到返回值不是一个pending状态的promise为止</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
        <span class="token parameter">y</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>bridgePromise<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//如果x是一个普通值，就让bridgePromise的状态fulfilled，并把这个值传递下去</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>首先，为防止使用者不传成功回调函数或不失败回调函数，我们给了默认回调函数，然后无论当前 promise 是什么状态，我们都返回一个 bridgePromise 用来衔接后续操作。</p> <p>另外执行回调函数时,因为回调函数既可能会返回一个异步的 promise 也可能会返回一个同步结果，所以我们把直接把回调函数的结果托管给 bridgePromise，使用 resolvePromise 方法来解析回调函数的结果，如果回调函数返回一个 promise 并且状态还是 pending，就在这个 promise 的 then 方法中继续解析这个 promise reslove 传过来的值，如果值还是 pending 状态的 promise 就继续解析，直到不是一个异步 promise，而是一个正常值就使用 bridgePromise 的 reslove 方法将 bridgePromise 的状态改为 fulfilled，并调用 onFulfilledCallbacks 回调数组中的方法，将该值传入，到此异步操作就衔接上了。</p> <p>这里很抽象，我们还是以文件顺序读取的场景画一张图解释一下流程：</p> <p>当执行<code>p.then(f1).then(f2).then(f3)</code>时:</p> <ol><li>先执行 p.then(f1)返回了一个 bridgePromise（p2），并在 p 的 onFulfilledCallbacks 回调列表中放入一个回调函数，回调函数负责执行 f1 并且更新 p2 的状态.</li> <li>然后.then(f2)时返回了一个 bridgePromise（p3），这里注意其实是 p2.then(f2)，因为 p.then(f1)时返回了 p2。此时在 p2 的 onFulfilledCallbacks 回调列表中放入一个回调函数，回调函数负责执行 f2 并且更新 p3 的状态.</li> <li>然后.then(f3)时返回了一个 bridgePromise（p4），并在 p3 的 onFulfilledCallbacks 回调列表中放入一个回调函数，回调函数负责执行 f3 并且更新 p4 的状态. 到此，回调关系注册完了，如图所示：</li></ol> <figure><img src="/images/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%86%99%E4%B8%80%E4%B8%AA%E7%AC%A6%E5%90%88Promises/640.webp" alt="An image"><figcaption>An image</figcaption></figure> <ol start="4"><li><p>然后过了一段时间，p 里面的异步操作执行完了，读取到了 1.txt 的内容，开始执行 p 的回调函数，回调函数执行 f1，打印出 1.txt 的内容“this is 1.txt”，并将 f1 的返回值放到 resolvePromise 中开始解析。resolvePromise 一看传入了一个 promise 对象，promise 是异步的啊，得等着呢，于是就在这个 promise 对象的 then 方法中继续 resolvePromise 这个 promise 对象 resolve 的结果，一看不是 promise 对象了，而是一个具体值“this is 2.txt”，于是调用 bridgePromise(p2)的 reslove 方法将 bridgePromise(p2)的状态更新为 fulfilled，并将“this is 2.txt”传入 p2 的回调函数中去执行。</p></li> <li><p>p2 的回调开始执行，f2 拿到传过来的“this is 2.txt”参数开始执行，打印出 2.txt 的内容，并将 f2 的返回值放到 resolvePromise 中开始解析，resolvePromise 一看传入了一个 promise 对象，promise 是异步的啊，又得等着呢…后续操作就是不断的重复 4,5 步直到结束。
到此，reslove 这一条线已经我们已经走通，让我们看看 reject 这一条线，reject 其实处理起来很简单:</p></li> <li><p>首先执行 fn 及执行注册的回调时都用 try-catch 包裹，无论哪里有异常都会进入 reject 分支。</p></li> <li><p>一旦代码进入 reject 分支直接将 bridge promise 设为 rejected 状态，于是后续都会走 reject 这个分支，另外如果不传异常处理的 onRejected 函数，默认就是使用 throw error 将错误一直往后抛，达到了错误冒泡的目的。</p></li> <li><p>最后可以实现一个 catch 函数用来接收错误。</p></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">catch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>到此，我们已经可以愉快的使用<code>promise.then(f1).then(f2).then(f3).catch(errorLog)</code>来顺序读取文件内容了。</p> <h3 id="本节代码-5"><a href="#本节代码-5" class="header-anchor">#</a> 本节代码</h3> <p>支持串行异步任务代码</p> <h2 id="六-达到-promises-a-规范"><a href="#六-达到-promises-a-规范" class="header-anchor">#</a> 六. 达到 Promises/A+规范</h2> <p>其实，到支持串行异步任务这一节，我们写的 promise 在功能上已经基本齐全了，但是还不太规范，比如说一些其他情况的判断等等，这一节我们就比着 Promises/A+的规范打磨一下我们写的 promise。如果只是想学习 promise 的核心实现的，这一节看不懂也没关系，因为这一节并没有增加 promise 的功能，只是使 promise 更加规范，更加健壮。</p> <h3 id="目标-6"><a href="#目标-6" class="header-anchor">#</a> 目标</h3> <p>使 promise 达到 Promises/A+规范，通过 promises-aplus-tests 的完整测试</p> <h3 id="实现-6"><a href="#实现-6" class="header-anchor">#</a> 实现</h3> <p>首先来可以了解一下 Promises/A+规范：
Promises/A+规范原版
Promises/A+规范中文版
相比上一节代码，本节代码除了在 resolvePromise 函数里增加了几个其他情况的判断外，其他函数都没有修改。完整 promise 代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">FULFILLED</span> <span class="token operator">=</span> <span class="token string">'fulfilled'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">MyPromise</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">PENDING</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>onFulfilledCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  self<span class="token punctuation">.</span>onRejectedCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">FULFILLED</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>onFulfilledCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">callback</span> <span class="token operator">=&gt;</span> <span class="token function">callback</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">REJECTED</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>error <span class="token operator">=</span> error<span class="token punctuation">;</span>
        self<span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">callback</span> <span class="token operator">=&gt;</span> <span class="token function">callback</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">fn</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">bridgepromise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//2.3.1规范，避免循环引用</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>bridgepromise <span class="token operator">===</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Circular reference'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> called <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token comment">//这个判断分支其实已经可以删除，用下面那个分支代替，因为promise也是一个thenable对象</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
        <span class="token parameter">y</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>bridgepromise<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 2.3.3规范，如果 x 为对象或者函数</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 是否是thenable对象（具有then方法的对象/函数）</span>
      <span class="token comment">//2.3.3.1 将 then 赋为 x.then</span>
      <span class="token keyword">let</span> then <span class="token operator">=</span> x<span class="token punctuation">.</span>then<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//2.3.3.3 如果 then 是一个函数，以x为this调用then函数，且第一个参数是resolvePromise，第二个参数是rejectPromise</span>
        <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
          x<span class="token punctuation">,</span>
          <span class="token parameter">y</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token function">resolvePromise</span><span class="token punctuation">(</span>bridgepromise<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//2.3.3.4 如果 then不是一个函数，则 以x为值fulfill promise。</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//2.3.3.2 如果在取x.then值时抛出了异常，则以这个异常做为原因将promise拒绝。</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
      called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> bridgePromise<span class="token punctuation">;</span>
  onFulfilled <span class="token operator">=</span> <span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onFulfilled</span> <span class="token operator">:</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> value<span class="token punctuation">;</span>
  onRejected <span class="token operator">=</span>
    <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span>
      <span class="token operator">?</span> <span class="token function-variable function">onRejected</span>
      <span class="token operator">:</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">FULFILLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>bridgePromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>bridgePromise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>bridgePromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>bridgePromise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>bridgePromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      self<span class="token punctuation">.</span>onFulfilledCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>bridgePromise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      self<span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>bridgePromise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">catch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 执行测试用例需要用到的代码</span>
MyPromise<span class="token punctuation">.</span><span class="token function-variable function">deferred</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> defer <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  defer<span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    defer<span class="token punctuation">.</span>resolve <span class="token operator">=</span> resolve<span class="token punctuation">;</span>
    defer<span class="token punctuation">.</span>reject <span class="token operator">=</span> reject<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> defer<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> MyPromise<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>我们可以先跑一下测试，需要安装一下测试插件,然后执行测试，测试时注意在加上上面最后的那几行代码才能执行测试用例。</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token number">1</span>.npm i -g promises-aplus-tests
<span class="token number">2</span>.promises-aplus-tests mypromise.js
</code></pre></div><p>运行测试用例可以看到，我们上面写的 promise 代码通过了完整的 Promises/A+规范测试。</p> <figure><img src="/images/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%86%99%E4%B8%80%E4%B8%AA%E7%AC%A6%E5%90%88Promises/640-1.webp" alt="An image"><figcaption>An image</figcaption></figure> <p>先撒花高兴一下~✿✿ ヽ(°▽°)ノ ✿</p> <p>然后开始分析我们这一节的代码，我们主要在 resolvePromise 里加了额外的两个判断，第一个是 x 和 bridgePromise 是指向相同值时，报出循环引用的错误，使 promise 符合 2.3.1 规范，然后我们增加了一个 x 为对象或者函数的判断，这一条判断主要对应 2.3.3 规范，中文规范如图：</p> <figure><img src="/images/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%86%99%E4%B8%80%E4%B8%AA%E7%AC%A6%E5%90%88Promises/640-2.webp" alt="An image"><figcaption>An image</figcaption></figure> <p>这一条标准对应的其实是 thenable 对象，什么是 thenable 对象，只要有 then 方法就是 thenable 对象,然后我们实现的时候照着规范实现就可以了。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 是否是thenable对象（具有then方法的对象/函数）</span>
    <span class="token comment">//2.3.3.1 将 then 赋为 x.then</span>
    <span class="token keyword">let</span> then <span class="token operator">=</span> x<span class="token punctuation">.</span>then<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//2.3.3.3 如果 then 是一个函数，以x为this调用then函数，且第一个参数是resolvePromise，第二个参数是rejectPromise</span>
      <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token parameter">y</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">resolvePromise</span><span class="token punctuation">(</span>bridgepromise<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//2.3.3.4 如果 then不是一个函数，则以x为值fulfill promise。</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//2.3.3.2 如果在取x.then值时抛出了异常，则以这个异常做为原因将promise拒绝。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>再写完这个分支的代码后，其实我们已经可以删除<code>if (x instanceof MyPromise) {}</code>这个分支的代码，因为 promise 也是一个 thenable 对象，完全可以使用上述代码兼容代替。另外，本节代码很多重复代码可以封装优化一下，但是为了看得清晰，并没有进行抽象封装，大家如果觉得重复代码太多的话，可以自行抽象封装。</p> <h3 id="本节代码-6"><a href="#本节代码-6" class="header-anchor">#</a> 本节代码</h3> <p>达到 Promises/A+规范代码</p> <h2 id="七-实现-promise-的-all，race，resolve，reject-方法"><a href="#七-实现-promise-的-all，race，resolve，reject-方法" class="header-anchor">#</a> 七. 实现 promise 的 all，race，resolve，reject 方法</h2> <p>上一节我们已经实现了一个符合 Promises/A+规范的 promise，本节我们把一些 es6 promise 里的常用方法实现一下。</p> <h3 id="目标-7"><a href="#目标-7" class="header-anchor">#</a> 目标</h3> <p>实现 es6 promise 的 all，race，resolve，reject 方法</p> <h3 id="实现-7"><a href="#实现-7" class="header-anchor">#</a> 实现</h3> <p>我们还是在之前的基础上继续往下写：</p> <div class="language-js extra-class"><pre class="language-js"><code>MyPromise<span class="token punctuation">.</span><span class="token function-variable function">all</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      promises<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
        <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          result<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>count <span class="token operator">==</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
MyPromise<span class="token punctuation">.</span><span class="token function-variable function">race</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      promises<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
        <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
MyPromise<span class="token punctuation">.</span><span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
MyPromise<span class="token punctuation">.</span><span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>其实前几节把 promise 的主线逻辑实现后，这些方法都不难实现，all 的原理就是返回一个 promise，在这个 promise 中给所有传入的 promise 的 then 方法中都注册上回调，回调成功了就把值放到结果数组中，所有回调都成功了就让返回的这个 promise 去 reslove，把结果数组返回出去，race 和 all 大同小异，只不过它不会等所有 promise 都成功，而是谁快就把谁返回出去，resolve 和 reject 的逻辑也很简单，看一下就明白了。</p> <h3 id="本节代码-7"><a href="#本节代码-7" class="header-anchor">#</a> 本节代码</h3> <p>实现 all，race，resolve，reject 方法代码</p> <h2 id="八-实现-promiseify-方法"><a href="#八-实现-promiseify-方法" class="header-anchor">#</a> 八. 实现 promiseify 方法</h2> <p>其实到上一节为止，promise 的方法已经都讲完了，这一节讲一个著名 promise 库 bluebird 里面的方法 promiseify，因为这个方法很常用而且以前面试还被问过。promiseify 有什么作用呢？它的作用就是将异步回调函数 api 转换为 promise 形式，比如下面这个，对 fs.readFile 执行 promiseify 后，就可以直接用 promise 的方式去调用读取文件的方法了，是不是很强大。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> Promise <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./bluebird'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> readFile <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span>readFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'1.txt'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="目标-8"><a href="#目标-8" class="header-anchor">#</a> 目标</h2> <p>实现 bluebird 的 promiseify 方法</p> <h2 id="实现-8"><a href="#实现-8" class="header-anchor">#</a> 实现</h2> <div class="language-js extra-class"><pre class="language-js"><code>MyPromise<span class="token punctuation">.</span><span class="token function-variable function">promisify</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> args <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>
        <span class="token keyword">null</span><span class="token punctuation">,</span>
        args<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          err <span class="token operator">?</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>虽然方法很强大，但是实现起来并没有很难，想在外边直接调用 promise 的方法那就返回一个 promise 呗，内部将原来参数后面拼接一个回调函数参数，在回调函数里执行这个 promise 的 reslove 方法把结果传出去，promiseify 就实现了。</p> <h2 id="本节代码-8"><a href="#本节代码-8" class="header-anchor">#</a> 本节代码</h2> <p>实现 promiseify 方法</p> <h2 id="最后"><a href="#最后" class="header-anchor">#</a> 最后</h2> <p>不知不觉写了这么多了，大家如果觉得还可以就给个赞呗，另外每一节的代码都托管到了 github 上，大家可以对照看那一节的 promise 实现代码及测试代码，也顺便求个 star~</p> <p>项目地址：本文代码的 github 仓库</p> <p>另外，实现一个符合 Promises/A+规范的 promise 不止本文一种实现方式，本文只是选取了一种比较通俗易懂的实现方式作为讲解，大家也可以用自己的方式去实现一个符合 Promises/A+规范的 promise。</p> <p><a href="https://mp.weixin.qq.com/s/kK-zAtXQy4FLnalaE7gRVA" target="_blank" rel="noopener noreferrer">从零开始写一个符合 Promises/A+规范的 promise<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div></div></div> <div id="shangfang" class="column no-pad-r sm-25 xl-33 xsNone smNone post-sidebar"><!----> <div class="table-contents-fixed"><h3 id="table-of-content" class="table-contents__title">浮动目录</h3> <nav><ol class="table-contents__list"></ol></nav></div></div> <aside id="dibujuli" class="column xs-100"><hr class="divider"> <div><div class="observer" data-v-48c5c728><!----> <!----> <!----></div></div> <hr class="divider"> <section class="post-content__disqus"><!----></section></aside></div></section></article></div> <section class="row section-newsletter justify-center newsletter-post-wrap"><div class="column sm-100 md-67 xl-50"><div class="newsletter not-black"><span class="meta-text meta-text--primary not-black">关注我们</span> <h2 class="newsletter__title not-black">在收件箱接收新的内容推送</h2> <form method="post" action="https://luzhaoyang.us4.list-manage.com/subscribe/post?u=1de83ba90307cf0e38650d622&amp;amp;id=04aeba270a" class="newsletter__form not-black"><label for="email_news-1581069954300" class="newsletter__label not-black"><input type="email" name="EMAIL" id="email_news-1581069954300" required="required" placeholder="在这里输入您的电子邮件" autocomplete="off" aria-label="在这里输入您的电子邮件" value="" class="ui-input-field reset-input newsletter__input"></label> <button type="submit" class="ui-button reset-button newsletter__button txt-upper ui-button--primary">
        订阅
      </button></form></div></div></section> <aside class="container main"></aside></div> <!----> <div class="elevator"><a class="elevator__link"><span class="icon elevator__icon icon-greaterthan"></span> <!----></a></div> <!----></div></main> <footer id="footer" class="footer "><div class="footer-box1"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 1366 161" class="footer-box__shape"><path d="M-11.925-4809v-154.746c40.454,19.75,273.683,130.936,420.544,142.612,161.25,12.821,339.978-42.709,521.543-86.3,169.82-40.769,395.43,29.2,423.912,38.429v60Z" transform="translate(11.926 4970)"></path></svg></div> <div class="footer-box2"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 1366 246" class="footer-box__shape"><path d="M-1505.5-4725.5v-238.1c8.149-3.133,18.138-5.059,29.672-5.9h30.954c201.21,11.667,696.6,224.535,855.572,236.458,205.129,15.385,287.179-164.1,432.047-175.625a42.381,42.381,0,0,1,16.756,1.857V-4725.5Z" transform="translate(1506 4971)"></path></svg> <ul class="footer-social__list"><li class="footer-social__item"><a href="https://i.youku.com/i/UNTcyNDQ2ODky?spm=a2hbt.13141534.1_1.1" target="_blank" rel="noopener external" title="Follow us on Facebook"><span class="icon footer-social__icon icon-youku"></span></a></li><li class="footer-social__item"><a href="https://weibo.com/3032335637/profile?rightmod=1&amp;wvr=6&amp;mod=personinfo" target="_blank" rel="noopener external" title="Follow us on Facebook"><span class="icon footer-social__icon icon-sina"></span></a></li><li class="footer-social__item"><a href="https://space.bilibili.com/25739142" target="_blank" rel="noopener external" title="Follow us on Facebook"><span class="icon footer-social__icon icon-bilibili"></span></a></li></ul> <div class="footer-newsletter not-black"><div class="newsletter not-black"><span class="meta-text meta-text--primary not-black">关注我们</span> <h2 class="newsletter__title not-black">在收件箱接收新的内容推送</h2> <form method="post" action="https://luzhaoyang.us4.list-manage.com/subscribe/post?u=1de83ba90307cf0e38650d622&amp;amp;id=04aeba270a" class="newsletter__form not-black"><label for="email_news-1581069954489" class="newsletter__label not-black"><input type="email" name="EMAIL" id="email_news-1581069954489" required="required" placeholder="在这里输入您的电子邮件" autocomplete="off" aria-label="在这里输入您的电子邮件" value="" class="ui-input-field reset-input newsletter__input"></label> <button type="submit" class="ui-button reset-button newsletter__button txt-upper ui-button--primary">
        订阅
      </button></form></div></div></div> <section class="footer-box3"><div class="row"><div class="column sm-50 footer-card"><div class="observer" data-v-48c5c728><div class="spinner observer__spinner" data-v-48c5c728><div class="double-bounce1"></div> <div class="double-bounce2"></div></div> <!----> <!----></div></div> <div class="column sm-50 footer-nav"><div class="row justify-right"><div class="column xs-50 sm-40 md-33 footer-nav__box footer-nav__box--1 not-black"><h2 class="meta-text title not-black">我的小窝</h2> <nav class="footer-nav1"><ul><li class="footer-nav1__item"><a href="/zh/categories/" class="not-black">文章分类</a> <!----></li><li class="footer-nav1__item"><a href="/zh/gallery/" class="not-black">摄影相册</a> <!----></li><!----><li class="footer-nav1__item"><a href="/zh/travel/" class="not-black">旅行简记</a> <!----></li><li class="footer-nav1__item"><a href="/zh/about/" class="not-black">关于我们</a> <!----></li><li class="footer-nav1__item"><a href="/zh/contact/" class="not-black">联系我们</a> <!----></li></ul></nav></div> <div class="column xs-50 sm-40 md-33 footer-nav__box footer-nav__box--2"><h2 class="meta-text title not-black">社区</h2> <nav class="footer-nav2"><ul><li class="footer-nav2__item"><!----> <a href="https://jq.qq.com/?_wv=1027&amp;k=5sOoWzp" rel="noopener nofollow" target="_blank" class="not-black">Q群 931024509</a></li><li class="footer-nav2__item"><!----> <a href="https://nativescript-vue-examples.luzhaoyang.com/" rel="noopener nofollow" target="_blank" class="not-black">NSVue 示例</a></li></ul></nav></div></div></div> <div class="cpolumn sm-100 footer-copy"><p data-v-8d1f1b8e><span data-v-8d1f1b8e>累计访问</span> <span data-v-8d1f1b8e></span>
  次
</p> <p>2018 - 2020 © NUOCHONG - 源于 
  <a href="https://github.com/" rel="noopener" target="_blank">
    GITHUB
  </a></p></div></div> <span class="shapes shapes--circle" style="left: 3%; top: -20%"></span> <span class="shapes shapes--primary shapes--color3" style="left: 30%; top: -15%"></span> <span class="shapes shapes--primary" style="left: 13%; top: -80%; transform: rotate(45deg)"></span> <span class="shapes shapes--circle shapes--color4" style="left: 40%; top: 200px"></span> <span class="shapes shapes--primary" style="left: 15%; bottom: 10%; transform: rotate(75deg)"></span> <span class="shapes shapes--circle shapes--color3" style="right: 50%; top: 30%"></span> <span class="shapes shapes--primary" style="right: 20%; top: -100%"></span> <span class="shapes shapes--circle" style="right: 10%; top: -20%"></span> <span class="shapes shapes--color4" style="right: 35%; top: -20%; transform: rotate(45deg)"></span> <span class="shapes shapes--circle" style="left: 40%; top: -50%"></span> <span class="shapes shapes--color3" style="right: 30%; top: 20%"></span> <span class="shapes shapes--circle shapes--primary" style="right: 30%; bottom: 20%"></span></section></footer></div> <!----> <!----></div><div class="global-ui"><div><!----> <!----></div></div></div>
    <script src="/assets/js/app.f17750b6.js" defer></script><script src="/assets/js/21.f825acf5.js" defer></script><script src="/assets/js/6.cfe3b70b.js" defer></script><script src="/assets/js/20.79d369cd.js" defer></script><script src="/assets/js/19.3996e2bb.js" defer></script><script src="/assets/js/27.f7590f54.js" defer></script><script src="/assets/js/1.35798176.js" defer></script><script src="/assets/js/5.c8a8d801.js" defer></script><script src="/assets/js/4.257a7894.js" defer></script><script src="/assets/js/24.07b0d058.js" defer></script><script src="/assets/js/74.90172a40.js" defer></script><script src="/assets/js/7.d6491bc5.js" defer></script><script src="/assets/js/14.1c7be7f5.js" defer></script><script src="/assets/js/2.d9691f81.js" defer></script><script src="/assets/js/12.2eb092a6.js" defer></script><script src="/assets/js/22.2f4cdc37.js" defer></script><script src="/assets/js/3.0a28d219.js" defer></script>
  </body>
</html>
